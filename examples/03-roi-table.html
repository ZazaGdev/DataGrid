<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DataGrid - ROI Calculator Table</title>
    <link rel="stylesheet" href="../dist/datagrid.min.css" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 2rem;
        background: #f3f4f6;
        margin: 0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #111827;
        margin-bottom: 0.5rem;
      }
      .description {
        color: #6b7280;
        margin-bottom: 1.5rem;
      }
      .toolbar {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        background: white;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 150ms ease;
      }
      .btn:hover {
        background: #f9fafb;
      }
      .btn-primary {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }
      .btn-primary:hover {
        background: #2563eb;
      }
      .info-box {
        margin-top: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
      }
      .info-box h3 {
        margin: 0 0 0.5rem 0;
        font-size: 0.875rem;
        color: #111827;
      }
      .info-box p {
        margin: 0.25rem 0;
        font-size: 0.875rem;
        color: #6b7280;
      }
      select {
        padding: 0.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        font-size: 0.875rem;
      }
      label {
        font-size: 0.875rem;
        color: #374151;
        margin-right: 0.5rem;
      }
      /* Row action icon sizing */
      .dg-row-action svg {
        width: 16px;
        height: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ’° ROI Calculator Table</h1>
      <p class="description">
        This example demonstrates an ROI (Return on Investment) calculator table
        with Benefits and Costs groups. Each row represents a benefit or cost
        item across multiple time periods. The table includes automatic totals
        and calculated metrics like Cash Flow and Cumulative Cash Flow.
      </p>

      <div class="toolbar">
        <label for="periodType">Period Type:</label>
        <select id="periodType">
          <option value="year">Years</option>
          <option value="month">Months</option>
        </select>
        <label for="periodCount" style="margin-left: 1rem">Periods:</label>
        <select id="periodCount">
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5" selected>5</option>
          <option value="6">6</option>
        </select>
        <button
          class="btn btn-primary"
          id="expandAll"
          style="margin-left: 1rem"
        >
          Expand All
        </button>
        <button class="btn btn-primary" id="collapseAll">Collapse All</button>
        <button class="btn" id="toggleBadges" style="margin-left: 1rem">
          Toggle Badges
        </button>
      </div>

      <div id="tableContainer"></div>

      <div class="info-box">
        <h3>ðŸ’¡ How It Works</h3>
        <p>
          â€¢ <strong>Benefits (Green):</strong> Revenue and savings items that
          contribute positively to ROI.
        </p>
        <p>
          â€¢ <strong>Costs (Red):</strong> Expenses and investments that are
          subtracted from benefits.
        </p>
        <p>
          â€¢ <strong>Total Column:</strong> Automatically sums all period values
          for each row.
        </p>
        <p>
          â€¢ <strong>Calculated Rows:</strong> Cash Flow, Cumulative Cash Flow,
          and Discounted Cash Flow are calculated from the data.
        </p>
        <p>
          â€¢ <strong>Edit Mode:</strong> Click on any value to edit it. Changes
          automatically recalculate totals.
        </p>
      </div>
    </div>

    <script type="module">
      import { Table } from "../src/index.js"

      // Configuration
      let periodType = "year"
      let periodCount = 5
      let discountRate = 0.06 // 6% discount rate for DCF

      // Generate period columns dynamically
      function generateColumns() {
        const baseYear = 2025
        const columns = [
          {
            title: "Name",
            data: "name",
            width: "350px",
            render: (value, row) => {
              // Add icons to ungrouped metric rows
              if (!row.group && row._type !== "infoRow" && value) {
                const icons = {
                  "CASH FLOW": `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#3b82f6" style="width:16px;height:16px;vertical-align:middle;margin-left:8px"><path fill-rule="evenodd" d="M12.577 4.878a.75.75 0 01.919-.53l4.78 1.281a.75.75 0 01.531.919l-1.281 4.78a.75.75 0 01-1.449-.387l.81-3.022a19.407 19.407 0 00-5.594 5.203.75.75 0 01-1.139.093L7 10.06l-4.72 4.72a.75.75 0 01-1.06-1.061l5.25-5.25a.75.75 0 011.06 0l3.074 3.073a20.923 20.923 0 015.545-4.931l-3.042-.815a.75.75 0 01-.53-.919z" clip-rule="evenodd"/></svg>`,
                  "CUMULATIVE CASH FLOW": `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#8b5cf6" style="width:16px;height:16px;vertical-align:middle;margin-left:8px"><path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h16.5a.75.75 0 010 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h16.5a.75.75 0 010 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 000 1.5h10.5a.75.75 0 000-1.5H1.75z" clip-rule="evenodd"/></svg>`,
                  "DISCOUNTED CASH FLOW": `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#f59e0b" style="width:16px;height:16px;vertical-align:middle;margin-left:8px"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.732 6.232a2.5 2.5 0 013.536 0 .75.75 0 101.06-1.06A4 4 0 006.5 8v.165c0 .364.034.728.1 1.085h-.35a.75.75 0 000 1.5h.737a5.25 5.25 0 01-.367 3.072l-.055.123a.75.75 0 00.848 1.037l1.272-.283a3.493 3.493 0 011.604.021 4.992 4.992 0 002.422 0l.97-.242a.75.75 0 00-.363-1.456l-.971.243a3.491 3.491 0 01-1.694 0 4.992 4.992 0 00-2.258-.038c.19-.811.227-1.651.111-2.477H9.75a.75.75 0 000-1.5H8.136A4.397 4.397 0 018 8.165V8c0-.641.244-1.22.732-1.768z" clip-rule="evenodd"/></svg>`,
                  "CUMULATIVE DISCOUNTED CASH FLOW": `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#10b981" style="width:16px;height:16px;vertical-align:middle;margin-left:8px"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/></svg>`,
                }
                const icon = icons[value] || ""
                return `${value}${icon}`
              }
              return value
            },
          },
        ]

        // Add period columns
        for (let i = 1; i <= periodCount; i++) {
          const periodLabel = periodType === "year" ? `Year ${i}` : `Month ${i}`
          const subLabel =
            periodType === "year" ? `${baseYear + i - 1}` : `${i}/${baseYear}`

          columns.push({
            title: periodLabel,
            data: `period${i}`,
            width: "120px",
            type: "number",
            aggregate: "sum",
            format: (value) =>
              value !== null && value !== undefined
                ? `$${Number(value).toLocaleString("en-US", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  })}`
                : "$0.00",
          })
        }

        return columns
      }

      // Generate ROI data
      function generateData() {
        const data = []

        // Info row header - shows period labels (2025, 2026, etc.)
        // This row appears at the top of tbody, not inside any group
        data.push({
          name: "",
          _type: "infoRow",
          ...generatePeriodSubheaders(),
        })

        data.push({
          name: "Labor Cost Savings",
          group: "Benefits",
          period1: 5000,
          period2: 5000,
          period3: 5000,
          period4: 5000,
          period5: 5000,
          period6: 5000,
          _badge: {
            content: '<span class="dg-badge-success">New</span>',
            position: "center-end",
          },
        })

        data.push({
          name: "Error & Rework Cost Reduction",
          group: "Benefits",
          period1: 6000,
          period2: 6000,
          period3: 6000,
          period4: 6000,
          period5: 6000,
          period6: 6000,
          _badge: {
            content: '<span class="dg-badge-warning">Pending</span>',
            position: "bottom-end",
          },
        })

        data.push({
          name: "Operational Cost Reduction",
          group: "Benefits",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-success">Active</span>',
        })

        data.push({
          name: "Productivity Gains",
          group: "Benefits",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-success">Active</span>',
        })

        data.push({
          name: "Faster Time-to-Market",
          group: "Benefits",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-warning">Pending</span>',
        })

        // Costs Group - no info row header for this group
        data.push({
          name: "Software Licensing",
          group: "Costs",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-error">Required</span>',
        })

        data.push({
          name: "Implementation Services",
          group: "Costs",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-error">Required</span>',
        })

        data.push({
          name: "Training & Change Management",
          group: "Costs",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-warning">Review</span>',
        })

        data.push({
          name: "Infrastructure & Hardware",
          group: "Costs",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-warning">Review</span>',
        })

        data.push({
          name: "Ongoing Maintenance",
          group: "Costs",
          period1: 0,
          period2: 0,
          period3: 0,
          period4: 0,
          period5: 0,
          period6: 0,
          _badge: '<span class="dg-badge-success">Approved</span>',
        })

        console.log(data)
        return data
      }

      // Generate period subheaders (year numbers)
      function generatePeriodSubheaders() {
        const baseYear = 2025
        const subheaders = {}
        for (let i = 1; i <= periodCount; i++) {
          subheaders[`period${i}`] =
            periodType === "year" ? baseYear + i - 1 : `${i}/${baseYear}`
        }
        console.log(subheaders)
        return subheaders
      }

      // Calculate metrics (ungrouped rows)
      function calculateMetrics(tableData) {
        const metrics = []
        const benefitsData = tableData.filter(
          (r) => r.group === "Benefits" && r._type !== "infoRow"
        )
        const costsData = tableData.filter(
          (r) => r.group === "Costs" && r._type !== "infoRow"
        )

        // Cash Flow = Total Benefits - Total Costs per period
        const cashFlow = {
          name: "CASH FLOW",
          group: null,
          _editable: false,
          _colorCoding: true,
        }

        let cashFlowTotal = 0
        for (let i = 1; i <= periodCount; i++) {
          const benefitSum = benefitsData.reduce(
            (sum, r) => sum + (Number(r[`period${i}`]) || 0),
            0
          )
          const costSum = costsData.reduce(
            (sum, r) => sum + (Number(r[`period${i}`]) || 0),
            0
          )
          cashFlow[`period${i}`] = benefitSum - costSum
          cashFlowTotal += cashFlow[`period${i}`]
        }
        cashFlow._rowTotal = cashFlowTotal
        metrics.push(cashFlow)

        // Cumulative Cash Flow
        const cumulativeCashFlow = {
          name: "CUMULATIVE CASH FLOW",
          group: null,
          _editable: false,
        }

        let cumulative = 0
        let cumulativeTotal = 0
        for (let i = 1; i <= periodCount; i++) {
          cumulative += cashFlow[`period${i}`]
          cumulativeCashFlow[`period${i}`] = cumulative
        }
        cumulativeCashFlow._rowTotal = cumulative // Last cumulative value
        metrics.push(cumulativeCashFlow)

        // Discounted Cash Flow (DCF)
        const discountedCashFlow = {
          name: "DISCOUNTED CASH FLOW",
          group: null,
          _editable: false,
        }
        let dcfTotal = 0
        for (let i = 1; i <= periodCount; i++) {
          const discountFactor = Math.pow(1 + discountRate, i)
          discountedCashFlow[`period${i}`] =
            cashFlow[`period${i}`] / discountFactor
          dcfTotal += discountedCashFlow[`period${i}`]
        }
        discountedCashFlow._rowTotal = dcfTotal
        metrics.push(discountedCashFlow)

        // Cumulative Discounted Cash Flow
        const cumulativeDCF = {
          name: "CUMULATIVE DISCOUNTED CASH FLOW",
          group: null,
          _editable: false,
        }
        let cumulativeDcf = 0
        for (let i = 1; i <= periodCount; i++) {
          cumulativeDcf += discountedCashFlow[`period${i}`]
          cumulativeDCF[`period${i}`] = cumulativeDcf
        }
        cumulativeDCF._rowTotal = cumulativeDcf
        metrics.push(cumulativeDCF)

        return metrics
      }

      // Create and render table
      let table = null

      function createTable() {
        if (table) {
          table.destroy()
        }

        const columns = generateColumns()
        const baseData = generateData()
        const metrics = calculateMetrics(baseData)

        // Combine all data
        const allData = [...baseData, ...metrics]

        table = new Table({
          container: "#tableContainer",
          columns: columns,
          data: allData,
          enableGrouping: true,
          groupBy: "group",
          groups: {
            labels: {
              Benefits:
                'Benefits <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#10b981" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/></svg> ',
              Costs:
                'Costs <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#ef4444" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd"/></svg> ',
            },
          },
          enableRowTotals: true,
          rowTotalsFormat: (value) =>
            value !== null && value !== undefined
              ? `$${Number(value).toLocaleString("en-US", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                })}`
              : "$0.00",
          fixedFirstColumn: true,
          mode: "edit",
          theme: {
            ungroupedRowBackground: "#F5492733", // Light red for ungrouped metric rows EXAMPLE
          },
          // Only show actions on grouped rows (Benefits/Costs), not on metrics rows
          actionsShowIf: (row) => !!row.group,
          // Row actions configuration
          actions: [
            {
              icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
              </svg>`,
              tooltip: "View Details",
              onClick: (row) => {
                console.log("View row:", row)
                alert(
                  `Viewing: ${row.name}\nGroup: ${row.group || "Ungrouped"}`
                )
              },
            },
            {
              icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>`,
              tooltip: "Delete Row",
              onClick: (row) => {
                if (confirm(`Delete "${row.name}"?`)) {
                  console.log("Delete row:", row._id)
                  table.deleteRow(row._id)
                  recalculateMetrics()
                }
              },
            },
          ],
        })

        // Store globally for debugging
        window.table = table

        // Subscribe to cell changes to recalculate metrics
        table.on(Table.Events.CELL_CHANGE, () => {
          recalculateMetrics()
        })
      }

      // Recalculate metrics when data changes
      function recalculateMetrics() {
        const tableData = table.getData()

        // Filter out old metrics and recalculate
        const baseData = tableData.filter(
          (r) => r.group === "Benefits" || r.group === "Costs"
        )
        const newMetrics = calculateMetrics(baseData)

        // Update metric rows in place
        const metricNames = [
          "CASH FLOW",
          "CUMULATIVE CASH FLOW",
          "DISCOUNTED CASH FLOW",
          "CUMULATIVE DISCOUNTED CASH FLOW",
        ]

        newMetrics.forEach((metric, index) => {
          const existingRow = tableData.find((r) => r.name === metric.name)
          if (existingRow) {
            for (let i = 1; i <= periodCount; i++) {
              table.updateCell(
                existingRow._id,
                `period${i}`,
                metric[`period${i}`]
              )
            }
          }
        })
      }

      // Initialize
      createTable()

      // Event handlers
      document.getElementById("periodType").addEventListener("change", (e) => {
        periodType = e.target.value
        createTable()
      })

      document.getElementById("periodCount").addEventListener("change", (e) => {
        periodCount = parseInt(e.target.value)
        createTable()
      })

      document.getElementById("expandAll").addEventListener("click", () => {
        table.expandAllGroups()
      })

      document.getElementById("collapseAll").addEventListener("click", () => {
        table.collapseAllGroups()
      })

      // Badge toggle demo - cycles through different badge states for ALL rows
      let badgeState = 0
      const badgeStates = [
        { label: "New", class: "dg-badge-success" },
        { label: "Updated", class: "dg-badge-warning" },
        { label: "Review", class: "dg-badge-error" },
        { label: null, class: null }, // No badge
      ]

      document.getElementById("toggleBadges").addEventListener("click", () => {
        const rows = table.getData()
        badgeState = (badgeState + 1) % badgeStates.length
        const currentBadge = badgeStates[badgeState]

        // Update badges on ALL grouped rows (Benefits and Costs)
        rows.forEach((row) => {
          // Skip info rows and ungrouped rows (metrics)
          if (row._type === "infoRow" || !row.group) return

          if (currentBadge.label) {
            table.updateRowBadge(
              row._id,
              `<span class="${currentBadge.class}">${currentBadge.label}</span>`
            )
          } else {
            table.updateRowBadge(row._id, null)
          }
        })

        // Update button text to show current state
        const btn = document.getElementById("toggleBadges")
        btn.textContent = currentBadge.label
          ? `Badge: ${currentBadge.label}`
          : "Badge: Off"
      })

      console.log("âœ… ROI Calculator loaded successfully!")
    </script>
  </body>
</html>
