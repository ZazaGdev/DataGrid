/*!
 * DataGrid v1.0.0
 * A modular, high-performance inline editing table library
 * (c) 2025
 * Released under the MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).DataGrid={})}(this,function(t){"use strict";class e{constructor(){this._listeners=new Map,this._onceListeners=new Map,this._isBatching=!1,this._batchQueue=[]}on(t,e){return this._listeners.has(t)||this._listeners.set(t,new Set),this._listeners.get(t).add(e),()=>this.off(t,e)}once(t,e){const s=o=>{this.off(t,s),e(o)};this.on(t,s)}off(t,e){this._listeners.has(t)&&this._listeners.get(t).delete(e)}emit(t,e){this._isBatching?this._batchQueue.push({event:t,data:e}):this._listeners.has(t)&&this._listeners.get(t).forEach(s=>{try{s(e)}catch(e){console.error(`Error in event handler for "${t}":`,e)}})}startBatch(){this._isBatching=!0,this._batchQueue=[]}endBatch(){this._isBatching=!1;const t=new Map;this._batchQueue.forEach(({event:e,data:o})=>{let r=e;e===s.CELL_CHANGE&&o.rowId&&o.columnName?r=`${e}:${o.rowId}:${o.columnName}`:e===s.ROW_CHANGE&&o.rowId&&(r=`${e}:${o.rowId}`),t.set(r,{event:e,data:o})}),t.forEach(({event:t,data:e})=>{this.emit(t,e)}),this._batchQueue=[]}destroy(){this._listeners.clear(),this._batchQueue=[]}}const s={STATE_CHANGE:"state:change",DATA_CHANGE:"data:change",ROW_CLICK:"row:click",ROW_CHANGE:"row:change",ROW_ADD:"row:add",ROW_DELETE:"row:delete",CELL_CHANGE:"cell:change",CELL_FOCUS:"cell:focus",CELL_BLUR:"cell:blur",ROW_TOTAL_CHANGE:"rowTotal:change",GROUP_TOGGLE:"group:toggle",GROUP_EXPAND_ALL:"group:expandAll",GROUP_COLLAPSE_ALL:"group:collapseAll",MODE_CHANGE:"mode:change",BEFORE_RENDER:"lifecycle:beforeRender",RENDER:"lifecycle:render",AFTER_RENDER:"lifecycle:afterRender",DESTROY:"lifecycle:destroy",SCROLL:"scroll:update",EXPORT_START:"export:start",EXPORT_COMPLETE:"export:complete"};function o(){return`et_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}function r(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof Set)return new Set([...t].map(t=>r(t)));if(t instanceof Map)return new Map([...t].map(([t,e])=>[r(t),r(e)]));if(Array.isArray(t))return t.map(t=>r(t));const e={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=r(t[s]));return e}function a(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(typeof t!=typeof e)return!1;if("object"!=typeof t)return t===e;if(Array.isArray(t)!==Array.isArray(e))return!1;if(Array.isArray(t))return t.length===e.length&&t.every((t,s)=>a(t,e[s]));const s=Object.keys(t),o=Object.keys(e);return s.length===o.length&&s.every(s=>a(t[s],e[s]))}function i(t,e=0){if(null==t||""===t)return e;const s=parseFloat(t);return isNaN(s)?e:s}function n(t){return t.reduce((t,e)=>t+i(e),0)}function l(t){return 0===t.length?0:n(t)/t.length}function h(t){const e=t.filter(t=>!isNaN(i(t)));return e.length?Math.min(...e.map(i)):0}function d(t){const e=t.filter(t=>!isNaN(i(t)));return e.length?Math.max(...e.map(i)):0}class u{constructor(t,e={}){this._eventBus=t,this._state={data:[],originalData:[],columns:[],mode:"view",groups:{},groupedData:null,collapsedGroups:new Set,focusedCell:null,computedCache:new Map,dirtyRows:new Set,dirtyColumns:new Map,config:{fixedFirstColumn:!1,enableGrouping:!1,groupBy:null,enableInfoRows:!1,enableRowTotals:!1,...e.config}},e.data&&this.setData(e.data),e.columns&&this.setColumns(e.columns)}setData(t){this._state.originalData=r(t),this._state.data=this._normalizeData(t),this._state.dirtyRows.clear(),this._invalidateCache(),this._state.config.enableGrouping&&this._state.config.groupBy&&this._computeGroups(),this._eventBus.emit(s.DATA_CHANGE,{data:this._state.data,source:"setData"})}getData(){return r(this._state.data)}getRow(t){const e=this._state.data.find(e=>e._id===t);return e?r(e):null}updateCell(t,e,o,i={}){const n=this._state.data.findIndex(e=>e._id===t);if(-1===n)return;const l=this._state.data[n],h=l[e];a(h,o)||(l[e]=o,this._state.dirtyRows.add(t),this._state.dirtyColumns.has(t)||this._state.dirtyColumns.set(t,new Set),this._state.dirtyColumns.get(t).add(e),this._invalidateCacheForRow(t,e),this._eventBus.emit(s.CELL_CHANGE,{rowId:t,rowIndex:n,columnName:e,oldValue:h,newValue:o,row:r(l)}),this._eventBus.emit(s.ROW_CHANGE,{rowId:t,rowIndex:n,columnName:e,row:r(l),dirtyColumns:Array.from(this._state.dirtyColumns.get(t)||[])}),i.skipCascade||this._triggerCascadeUpdate(t,e,o))}batchUpdate(t){this._eventBus.startBatch(),t.forEach(({rowId:t,columnName:e,value:s})=>{this.updateCell(t,e,s,{skipCascade:!0})}),this._computeAllCascades(),this._eventBus.endBatch(),this._eventBus.emit(s.DATA_CHANGE,{data:this._state.data,source:"batchUpdate",updatedRows:t.map(t=>t.rowId)})}setColumns(t){this._state.columns=t.map((t,e)=>({...t,_index:e,_id:t.id||t.data||`col_${e}`})),this._eventBus.emit(s.STATE_CHANGE,{property:"columns",value:this._state.columns})}getColumns(){const t=[...this._state.columns];if(this._state.config.enableRowTotals){const e=t=>null!=t?`$${Number(t).toLocaleString()}`:"$0";t.push({data:"_rowTotal",title:"Total",type:"number",editable:!1,aggregate:"sum",_id:"_rowTotal",_index:t.length,_isRowTotal:!0,format:this._state.config.rowTotalsFormat||e})}return t}getColumn(t){if("_rowTotal"===t&&this._state.config.enableRowTotals){const t=t=>null!=t?`$${Number(t).toLocaleString()}`:"$0";return{data:"_rowTotal",title:"Total",type:"number",editable:!1,aggregate:"sum",_id:"_rowTotal",_isRowTotal:!0,format:this._state.config.rowTotalsFormat||t}}return this._state.columns.find(e=>e._id===t||e.data===t)}setMode(t){if("view"!==t&&"edit"!==t)return void console.warn(`Invalid mode: ${t}. Must be 'view' or 'edit'.`);const e=this._state.mode;this._state.mode=t,this._eventBus.emit(s.MODE_CHANGE,{oldMode:e,newMode:t})}getMode(){return this._state.mode}isEditMode(){return"edit"===this._state.mode}toggleGroup(t){this._state.collapsedGroups.has(t)?this._state.collapsedGroups.delete(t):this._state.collapsedGroups.add(t),this._eventBus.emit(s.GROUP_TOGGLE,{groupId:t,collapsed:this._state.collapsedGroups.has(t)})}isGroupCollapsed(t){return this._state.collapsedGroups.has(t)}getGroupedData(){return this._state.groupedData}getUngroupedRows(){return this._state.ungroupedRows||[]}getInfoRows(){return this._state.infoRows||[]}expandAllGroups(){this._state.collapsedGroups.clear(),this._eventBus.emit(s.GROUP_EXPAND_ALL,{})}collapseAllGroups(){this._state.groupedData&&Object.keys(this._state.groupedData).forEach(t=>{this._state.collapsedGroups.add(t)}),this._eventBus.emit(s.GROUP_COLLAPSE_ALL,{})}getDirtyRows(){return this._state.data.filter(t=>this._state.dirtyRows.has(t._id)).map(t=>r(t))}isRowDirty(t){return this._state.dirtyRows.has(t)}clearDirty(){this._state.dirtyRows.clear(),this._state.dirtyColumns.clear(),this._state.originalData=r(this._state.data)}revertChanges(){this.setData(this._state.originalData)}setConfig(t){this._state.config={...this._state.config,...t},void 0!==t.groupBy&&this._computeGroups(),this._eventBus.emit(s.STATE_CHANGE,{property:"config",value:this._state.config})}getConfig(){return{...this._state.config}}_normalizeData(t){return t.map((t,e)=>({...t,_id:t._id||t.id||o(),_index:e,_type:t._type||"data"}))}_computeGroups(){const{groupBy:t}=this._state.config;if(!t)return void(this._state.groupedData=null);const e={},s=[],o=[];this._state.data.forEach(r=>{if("infoRow"===r._type)return void o.push(r);if("data"!==r._type)return;const a="function"==typeof t?t(r):r[t];null!=a&&""!==a?(e[a]||(e[a]={id:a,label:a,rows:[],totals:{}}),e[a].rows.push(r)):s.push(r)}),this._state.groupedData=e,this._state.ungroupedRows=s,this._state.infoRows=o}_invalidateCache(){this._state.computedCache.clear()}_invalidateCacheForRow(t,e){this._state.computedCache.delete(`${t}:${e}`);const s=this.getColumn(e);s&&s.affectsColumns&&s.affectsColumns.forEach(t=>{this._state.computedCache.forEach((e,s)=>{s.includes(`:${t}`)&&this._state.computedCache.delete(s)})})}_triggerCascadeUpdate(t,e,s){const o=this.getColumn(e);o&&o.cascade&&o.cascade({rowId:t,columnName:e,value:s,state:this,updateCell:(t,e,s)=>{this.updateCell(t,e,s,{skipCascade:!0})}})}_computeAllCascades(){}destroy(){this._state.data=[],this._state.columns=[],this._state.computedCache.clear(),this._state.dirtyRows.clear(),this._state.dirtyColumns.clear(),this._state.collapsedGroups.clear()}}function c(t,e={}){const s=document.createElement(t);return function(t,e){Object.entries(e).forEach(([e,s])=>{"class"===e?t.className=s:"style"===e&&"object"==typeof s?Object.assign(t.style,s):e.startsWith("data-")?t.setAttribute(e,s):e in t?t[e]=s:t.setAttribute(e,s)})}(s,e),s}function _(t,...e){e.forEach(e=>{e&&t.classList.add(e)})}function p(t,...e){e.forEach(e=>{e&&t.classList.remove(e)})}class g{constructor(t,e){this._container=t,this._state=e,this._eventBus=e._eventBus,this._tableWrapper=null,this._table=null,this._thead=null,this._tbody=null,this._rowElements=new Map,this._cellElements=new Map,this._unsubscribers=[],this._setupEventListeners()}render(){const t=this._state.getConfig();this._tableWrapper||this._createStructure(),this._updateContainerClasses(t),this._renderHeader(),t.enableGrouping&&this._state.getGroupedData()?this._renderGroupedBody():this._renderBody()}updateCell(t,e,s){const o=`${t}:${e}`,r=this._cellElements.get(o);if(r){const o=this._state.getColumn(e);this._renderCellContent(r,s,o,this._state.getRow(t))}}updateRow(t){const e=this._rowElements.get(t),s=this._state.getRow(t);if(e&&s){this._state.getColumns().forEach(e=>{const o=`${t}:${e.data}`,r=this._cellElements.get(o);r&&this._renderCellContent(r,s[e.data],e,s)})}}getCellElement(t,e){return this._cellElements.get(`${t}:${e}`)||null}getRowElement(t){return this._rowElements.get(t)||null}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[],this._rowElements.clear(),this._cellElements.clear(),this._tableWrapper&&this._tableWrapper.remove()}_setupEventListeners(){this._unsubscribers.push(this._eventBus.on(s.CELL_CHANGE,({rowId:t,columnName:e,newValue:s})=>{this.updateCell(t,e,s)})),this._unsubscribers.push(this._eventBus.on(s.DATA_CHANGE,()=>{this.render()})),this._unsubscribers.push(this._eventBus.on(s.ROW_TOTAL_CHANGE,({rowId:t,newValue:e})=>{this.updateCell(t,"_rowTotal",e)})),this._unsubscribers.push(this._eventBus.on(s.STATE_CHANGE,({property:t,groupId:e})=>{"groupTotals"===t&&this._updateGroupHeaders(e)})),this._unsubscribers.push(this._eventBus.on(s.MODE_CHANGE,()=>{this.render()})),this._unsubscribers.push(this._eventBus.on(s.GROUP_TOGGLE,({groupId:t,collapsed:e})=>{this._toggleGroupVisibility(t,e)})),this._unsubscribers.push(this._eventBus.on(s.GROUP_EXPAND_ALL,()=>{this._setAllGroupsVisibility(!1)})),this._unsubscribers.push(this._eventBus.on(s.GROUP_COLLAPSE_ALL,()=>{this._setAllGroupsVisibility(!0)}))}_createStructure(){_(this._container,"et-container"),this._tableWrapper=c("div",{class:"et-table-wrapper"}),this._table=c("table",{class:"et-table"}),this._thead=c("thead",{class:"et-thead"}),this._tbody=c("tbody",{class:"et-tbody"}),this._table.appendChild(this._thead),this._table.appendChild(this._tbody),this._tableWrapper.appendChild(this._table),this._container.appendChild(this._tableWrapper)}_updateContainerClasses(t){const e=this._state.getMode();p(this._container,"et-mode-view","et-mode-edit"),_(this._container,`et-mode-${e}`),t.fixedFirstColumn?_(this._container,"et-fixed-first-column"):p(this._container,"et-fixed-first-column"),t.enableGrouping?_(this._container,"et-grouped"):p(this._container,"et-grouped")}_renderHeader(){const t=this._state.getColumns(),e=this._state.getConfig();this._thead.innerHTML="";const s=c("tr",{class:"et-header-row"});let o=0;t.forEach(t=>{if(!1===t.visible)return;const r=c("th",{class:"et-header-cell","data-column":t.data,"data-column-index":o});0===o&&e.fixedFirstColumn&&_(r,"et-cell-fixed"),t._isRowTotal&&_(r,"et-header-row-total");const a=c("div",{class:"et-header-content"});a.textContent=t.title||t.data,r.appendChild(a),t.width&&(r.style.width="number"==typeof t.width?`${t.width}px`:t.width),s.appendChild(r),o++}),this._thead.appendChild(s)}_renderBody(){const t=this._state.getData(),e=this._state.getColumns();this._tbody.innerHTML="",this._rowElements.clear(),this._cellElements.clear(),t.forEach(t=>{const s=this._createRowElement(t,e);this._tbody.appendChild(s)})}_renderGroupedBody(){const t=this._state.getGroupedData(),e=this._state.getUngroupedRows(),s=this._state.getInfoRows(),o=this._state.getColumns();this._tbody.innerHTML="",this._rowElements.clear(),this._cellElements.clear(),s&&s.length>0&&s.forEach(t=>{const e=this._createRowElement(t,o,null);_(e,"et-row-info"),this._tbody.appendChild(e)}),Object.entries(t).forEach(([t,e])=>{const s=this._createGroupHeaderRow(t,e,o);this._tbody.appendChild(s);const r=this._state.isGroupCollapsed(t);e.rows.forEach(e=>{const s=this._createRowElement(e,o,t);r&&_(s,"et-row-hidden"),this._tbody.appendChild(s)})}),e.length>0&&e.forEach(t=>{const e=this._createRowElement(t,o,null);_(e,"et-row-ungrouped"),this._tbody.appendChild(e)})}_createRowElement(t,e,o=null){const r=this._state.getConfig(),a=c("tr",{class:"et-row "+("infoRow"===t._type?"et-row-info-row":"et-row-data"),"data-row-id":t._id,"data-row-index":t._index});o&&a.setAttribute("data-group",o),this._state.isRowDirty(t._id)&&_(a,"et-row-dirty"),a.addEventListener("click",e=>{e.target.closest(".et-cell-input")||this._eventBus.emit(s.ROW_CLICK,{rowId:t._id,rowIndex:t._index,row:this._state.getRow(t._id),event:e})});let i=0;return e.forEach(e=>{if(!1===e.visible)return;const s=this._createCellElement(t,e,i,r);a.appendChild(s),this._cellElements.set(`${t._id}:${e.data}`,s),i++}),this._rowElements.set(t._id,a),a}_createCellElement(t,e,s,o){const r=c("td",{class:"et-cell","data-column":e.data});return 0===s&&o.fixedFirstColumn&&_(r,"et-cell-fixed"),e._isRowTotal&&_(r,"et-cell-row-total"),e.type&&_(r,`et-cell-${e.type}`),e.align&&(r.style.textAlign=e.align),this._renderCellContent(r,t[e.data],e,t),r}_renderCellContent(t,e,s,o){const r=this._state.isEditMode(),a=!1!==s.editable&&"infoRow"!==o._type&&!1!==o._editable;if(t.innerHTML="",r&&a){const r=this._createInputElement(e,s,o);t.appendChild(r)}else{const r=this._formatDisplayValue(e,s,o);if(s.render){const r=s.render(e,o,s);"string"==typeof r?t.innerHTML=r:r instanceof HTMLElement&&t.appendChild(r)}else t.textContent=r}}_createInputElement(t,e,o){const r=e.inputType||e.type||"text";let a;return"select"===r&&e.options?(a=c("select",{class:"et-cell-input et-cell-select"}),e.options.forEach(e=>{const s=c("option",{value:e.value||e});s.textContent=e.label||e,(e.value||e)===t&&(s.selected=!0),a.appendChild(s)})):"textarea"===r?(a=c("textarea",{class:"et-cell-input et-cell-textarea",value:t||""}),a.textContent=t||""):(a=c("input",{class:"et-cell-input",type:"number"===r?"number":"text",value:t??""}),"number"===r&&(void 0!==e.min&&(a.min=e.min),void 0!==e.max&&(a.max=e.max),void 0!==e.step&&(a.step=e.step))),a.addEventListener("focus",()=>{this._eventBus.emit(s.CELL_FOCUS,{rowId:o._id,columnName:e.data,value:t})}),a.addEventListener("blur",()=>{this._eventBus.emit(s.CELL_BLUR,{rowId:o._id,columnName:e.data,value:a.value})}),a.addEventListener("change",t=>{let s=t.target.value;"number"===r&&(s=""===s?null:parseFloat(s)),this._state.updateCell(o._id,e.data,s),e.onChange&&e.onChange({value:s,rowId:o._id,row:this._state.getRow(o._id),column:e})}),a}_formatDisplayValue(t,e,s){if(null==t)return e.defaultValue??"";if("infoRow"===s._type)return String(t);if(e.format)return e.format(t,s,e);if("number"===e.type&&"number"==typeof t)return void 0!==e.decimals?t.toFixed(e.decimals):t.toString();if("currency"===e.type){return new Intl.NumberFormat("en-US",{style:"currency",currency:e.currency||"USD"}).format(t)}if("date"===e.type&&t){return new Date(t).toLocaleDateString()}return String(t)}_createGroupHeaderRow(t,e,s){const o=this._state.getConfig(),r=this._state.isGroupCollapsed(t),a=s.filter(t=>!1!==t.visible),i=c("tr",{class:"et-row et-row-group-header","data-group":t}),n=e.totals||{};return a.forEach((s,a)=>{const l=c("td",{class:"et-cell et-cell-group-header","data-column":s.data});if(0===a&&o.fixedFirstColumn&&_(l,"et-cell-fixed"),s._isRowTotal&&_(l,"et-cell-row-total"),0===a){const s=c("div",{class:"et-group-header-content"}),o=c("span",{class:"et-group-toggle-icon "+(r?"et-collapsed":"et-expanded")});o.innerHTML=r?"▶":"▼";const a=c("span",{class:"et-group-label"});a.textContent=e.label||t;const i=c("span",{class:"et-group-count"});i.textContent=`(${e.rows.length})`,s.appendChild(o),s.appendChild(a),s.appendChild(i),l.appendChild(s)}else s.aggregate&&void 0!==n[s.data]&&(l.textContent=this._formatDisplayValue(n[s.data],s,{}),_(l,"et-cell-aggregate"));s.align&&(l.style.textAlign=s.align),i.appendChild(l)}),i.addEventListener("click",()=>{this._state.toggleGroup(t)}),i}_createTotalsRow(t,e,s){const o=this._state.getConfig(),r=c("tr",{class:"et-row et-row-totals","data-group":s});return e.forEach((e,s)=>{if(!1===e.visible)return;const a=c("td",{class:"et-cell et-cell-total","data-column":e.data});0===s&&o.fixedFirstColumn&&_(a,"et-cell-fixed"),void 0!==t[e.data]&&(a.textContent=this._formatDisplayValue(t[e.data],e,{})),r.appendChild(a)}),r}_toggleGroupVisibility(t,e){const s=this._tbody.querySelectorAll(`[data-group="${t}"]:not(.et-row-group-header)`),o=this._tbody.querySelector(`.et-row-group-header[data-group="${t}"]`);if(s.forEach(t=>{e?_(t,"et-row-hidden"):p(t,"et-row-hidden")}),o){const t=o.querySelector(".et-group-toggle-icon");t&&(t.innerHTML=e?"▶":"▼",e?(p(t,"et-expanded"),_(t,"et-collapsed")):(p(t,"et-collapsed"),_(t,"et-expanded")))}}_setAllGroupsVisibility(t){const e=this._state.getGroupedData();e&&Object.keys(e).forEach(e=>{this._toggleGroupVisibility(e,t)})}_updateGroupHeaders(t=null){if(!this._tbody)return;const e=this._state.getGroupedData();if(!e)return;const s=this._state.getColumns();(t?[t]:Object.keys(e)).forEach(t=>{const o=e[t];if(!o)return;const r=this._tbody.querySelector(`.et-row-group-header[data-group="${t}"]`);r&&s.forEach(t=>{if(t.aggregate&&void 0!==o.totals[t.data]){const e=r.querySelector(`[data-column="${t.data}"]`);e&&!e.querySelector(".et-group-header-content")&&(e.textContent=this._formatDisplayValue(o.totals[t.data],t,{}))}})})}}class m{constructor(t,e){this._state=t,this._eventBus=e,this._unsubscribers=[],this._setupListeners()}addRow(t,e={}){const r=this._state.getData(),{index:a,groupId:i,afterRowId:n,type:l="data"}=e,h={...t,_id:t._id||o(),_type:l};let d=r.length;if(void 0!==a)d=Math.max(0,Math.min(a,r.length));else if(n){const t=r.findIndex(t=>t._id===n);-1!==t&&(d=t+1)}else if(i){const t=this._state.getConfig().groupBy;for(let e=r.length-1;e>=0;e--){if(("function"==typeof t?t(r[e]):r[e][t])===i){d=e+1;break}}"string"==typeof t&&(h[t]=i)}return r.splice(d,0,h),r.forEach((t,e)=>{t._index=e}),this._state.setData(r),this._eventBus.emit(s.ROW_ADD,{row:h,index:d}),h}addInfoRow(t,e){return this.addRow(e,{afterRowId:t,type:"infoRow"})}deleteRow(t){const e=this._state.getData(),o=e.findIndex(e=>e._id===t);if(-1===o)return!1;const r=e[o];return e.splice(o,1),e.forEach((t,e)=>{t._index=e}),this._state.setData(e),this._eventBus.emit(s.ROW_DELETE,{rowId:t,row:r,index:o}),!0}deleteRows(t){let e=0;const s=new Set(t),o=this._state.getData().filter(t=>!s.has(t._id)||(e++,!1));return e>0&&(o.forEach((t,e)=>{t._index=e}),this._state.setData(o)),e}duplicateRow(t){const e=this._state.getRow(t);if(!e)return null;const{_id:s,_index:o,...r}=e;return this.addRow(r,{afterRowId:t})}moveRow(t,e){const s=this._state.getData(),o=s.findIndex(e=>e._id===t);if(-1===o)return!1;const[r]=s.splice(o,1);return s.splice(e,0,r),s.forEach((t,e)=>{t._index=e}),this._state.setData(s),!0}getRowsByType(t){return this._state.getData().filter(e=>e._type===t)}getDataRows(){return this.getRowsByType("data")}getInfoRows(t){const e=this._state.getData(),s=e.findIndex(e=>e._id===t);if(-1===s)return[];const o=[];for(let t=s+1;t<e.length&&"infoRow"===e[t]._type;t++)o.push(e[t]);return o}_setupListeners(){}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[]}}const f="sum",w="average",y="min",C="max",b="count",E="first",v="last",R={[f]:t=>n(t),[w]:t=>l(t),[y]:t=>h(t),[C]:t=>d(t),[b]:t=>t.length,[E]:t=>t[0],[v]:t=>t[t.length-1]};function T(t,e){const s={};return e.forEach(e=>{if(e.aggregate){const r=t.filter(t=>"data"===t._type).map(t=>t[e.data]).filter(t=>null!=t),a="function"==typeof(o=e.aggregate)?o:R[o]||R[f];s[e.data]=a(r,t)}var o}),s}class x{constructor(t,e){this._state=t,this._eventBus=e,this._unsubscribers=[],this._setupListeners(),this._state.getConfig().enableGrouping&&this.recalculateTotals(),this._state.getConfig().enableRowTotals&&this.recalculateRowTotals()}calculateRowTotal(t){const e=this._state.getColumns();let s=0;return e.forEach(e=>{if(e.aggregate&&"_rowTotal"!==e.data){const o=t[e.data];null==o||isNaN(o)||(s+=Number(o))}}),s}recalculateRowTotals(){if(!this._state.getConfig().enableRowTotals)return;this._state._state.data.forEach(t=>{"data"===t._type&&(t._rowTotal=this.calculateRowTotal(t))})}updateRowTotal(t){if(!this._state.getConfig().enableRowTotals)return;const e=this._state._state.data.find(e=>e._id===t);if(e&&"data"===e._type){const o=e._rowTotal;e._rowTotal=this.calculateRowTotal(e),o!==e._rowTotal&&this._eventBus.emit(s.ROW_TOTAL_CHANGE,{rowId:t,oldValue:o,newValue:e._rowTotal})}}getGroup(t){const e=this._state.getGroupedData();return e?e[t]:null}getGroupIds(){const t=this._state.getGroupedData();return t?Object.keys(t):[]}getGroupRows(t){const e=this.getGroup(t);return e?e.rows:[]}getGroupTotals(t){const e=this.getGroup(t);return e?e.totals:{}}recalculateTotals(t=null){const e=this._state.getGroupedData(),o=this._state.getColumns(),r=this._state.getConfig();if(!e)return;(t?[t].filter(t=>e[t]):Object.keys(e)).forEach(t=>{const s=e[t],a={},i=s.rows.filter(t=>"data"===t._type);if(o.forEach(t=>{if(t.aggregate&&"_rowTotal"!==t.data){const e=i.map(e=>e[t.data]).filter(t=>null!=t&&!isNaN(t));a[t.data]=this._calculateAggregate(t.aggregate,e,i)}}),r.enableRowTotals){let t=0;o.forEach(e=>{e.aggregate&&"_rowTotal"!==e.data&&void 0!==a[e.data]&&(t+=a[e.data])}),a._rowTotal=t}s.totals=a}),this._eventBus.emit(s.STATE_CHANGE,{property:"groupTotals",groupId:t})}getGrandTotals(){return T(this._state.getData().filter(t=>"data"===t._type),this._state.getColumns())}toggle(t){return this._state.toggleGroup(t),this._state.isGroupCollapsed(t)}expand(t){this._state.isGroupCollapsed(t)&&this._state.toggleGroup(t)}collapse(t){this._state.isGroupCollapsed(t)||this._state.toggleGroup(t)}expandAll(){this._state.expandAllGroups()}collapseAll(){this._state.collapseAllGroups()}isCollapsed(t){return this._state.isGroupCollapsed(t)}getExpansionState(){const t=this.getGroupIds(),e={};return t.forEach(t=>{e[t]=!this._state.isGroupCollapsed(t)}),e}setExpansionState(t){Object.entries(t).forEach(([t,e])=>{e?this.expand(t):this.collapse(t)})}moveRowToGroup(t,e){const s=this._state.getConfig().groupBy;"string"==typeof s?(this._state.updateCell(t,s,e),this.recalculateTotals()):console.warn("Cannot move row when groupBy is a function")}getGroupStats(t){const e=this.getGroup(t);if(!e)return null;const s=this._state.getColumns(),o={rowCount:e.rows.length,columns:{}};return s.forEach(t=>{if("number"===t.type){const s=e.rows.map(e=>e[t.data]).filter(t=>null!=t&&!isNaN(t));o.columns[t.data]={sum:n(s),average:l(s),min:h(s),max:d(s),count:s.length}}}),o}_calculateAggregate(t,e,s){if("function"==typeof t)return t(e,s);switch(t){case"sum":default:return n(e);case"average":case"avg":return l(e);case"min":return h(e);case"max":return d(e);case"count":return e.length;case"first":return e[0];case"last":return e[e.length-1]}}_setupListeners(){this._unsubscribers.push(this._eventBus.on(s.CELL_CHANGE,({rowId:t,columnName:e})=>{const s=this._state.getColumn(e),o=this._state.getConfig();if(o.enableRowTotals&&s&&s.aggregate&&this.updateRowTotal(t),s&&s.aggregate&&o.enableGrouping){const e=this._state.getRow(t);if(e){const t=o.groupBy,s="function"==typeof t?t(e):e[t];this.recalculateTotals(s)}}})),this._unsubscribers.push(this._eventBus.on(s.DATA_CHANGE,()=>{const t=this._state.getConfig();t.enableRowTotals&&this.recalculateRowTotals(),t.enableGrouping&&this.recalculateTotals()}))}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[]}}class B{constructor(t,e,s){this._state=t,this._eventBus=e,this._renderer=s,this._focusedCell=null,this._isEditing=!1,this._unsubscribers=[],this._setupListeners()}enterEditMode(){this._state.setMode("edit")}enterViewMode(){this._state.setMode("view"),this._focusedCell=null}toggleMode(){const t="view"===this._state.getMode()?"edit":"view";return this._state.setMode(t),t}isEditMode(){return this._state.isEditMode()}focusCell(t,e){if(this._focusedCell={rowId:t,columnName:e},this._state.isEditMode()){const s=this._renderer.getCellElement(t,e);if(s){const t=s.querySelector(".et-cell-input");t&&(t.focus(),t.select&&t.select())}}this._eventBus.emit(s.CELL_FOCUS,{rowId:t,columnName:e})}getFocusedCell(){return this._focusedCell}moveFocus(t){if(!this._focusedCell)return;const{rowId:e,columnName:s}=this._focusedCell,o=this._state.getData(),r=this._state.getColumns().filter(t=>!1!==t.visible),a=o.findIndex(t=>t._id===e),i=r.findIndex(t=>t.data===s);if(-1===a||-1===i)return;let n=a,l=i;switch(t){case"up":n=Math.max(0,a-1);break;case"down":n=Math.min(o.length-1,a+1);break;case"left":l=Math.max(0,i-1);break;case"right":l=Math.min(r.length-1,i+1)}if("up"===t||"down"===t){const e=o[n];if(e&&"data"!==e._type){const e="up"===t?-1:1;for(;n>=0&&n<o.length&&"data"!==o[n]._type;)n+=e;n=Math.max(0,Math.min(o.length-1,n))}}const h=o[n],d=r[l];h&&d&&this.focusCell(h._id,d.data)}startEditing(){if(!this._focusedCell||!this._state.isEditMode())return;this._isEditing=!0;const{rowId:t,columnName:e}=this._focusedCell,s=this._renderer.getCellElement(t,e);s&&_(s,"et-cell-editing")}stopEditing(){if(!this._focusedCell)return;this._isEditing=!1;const{rowId:t,columnName:e}=this._focusedCell,s=this._renderer.getCellElement(t,e);s&&p(s,"et-cell-editing")}isEditing(){return this._isEditing}cancelEdit(){if(!this._focusedCell||!this._isEditing)return;const{rowId:t,columnName:e}=this._focusedCell,s=this._state._state.originalData.find(e=>e._id===t);s&&this._state.updateCell(t,e,s[e]),this.stopEditing()}commitEdit(){if(!this._focusedCell||!this._isEditing)return;const{rowId:t,columnName:e}=this._focusedCell,s=this._renderer.getCellElement(t,e);if(s){const t=s.querySelector(".et-cell-input");t&&t.dispatchEvent(new Event("change",{bubbles:!0}))}this.stopEditing()}_setupListeners(){document.addEventListener("keydown",t=>{if(this._state.isEditMode())switch(t.key){case"Tab":t.preventDefault(),this.moveFocus(t.shiftKey?"left":"right");break;case"Enter":this._isEditing&&(t.preventDefault(),this.commitEdit(),this.moveFocus("down"));break;case"Escape":this._isEditing&&(t.preventDefault(),this.cancelEdit());break;case"ArrowUp":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("up"));break;case"ArrowDown":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("down"));break;case"ArrowLeft":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("left"));break;case"ArrowRight":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("right"))}}),this._unsubscribers.push(this._eventBus.on(s.CELL_FOCUS,({rowId:t,columnName:e})=>{this._focusedCell={rowId:t,columnName:e}})),this._unsubscribers.push(this._eventBus.on(s.CELL_BLUR,()=>{this._isEditing=!1})),this._unsubscribers.push(this._eventBus.on(s.MODE_CHANGE,({newMode:t})=>{"view"===t&&(this._focusedCell=null,this._isEditing=!1)}))}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[],this._focusedCell=null,this._isEditing=!1}}class G{constructor(t,e){this._state=t,this._eventBus=e}toCSV(t={}){const{delimiter:e=",",includeHeaders:o=!0,includeHidden:r=!1,columns:a=null,filter:i=null}=t;this._eventBus.emit(s.EXPORT_START,{format:"csv"});let n=this._state.getData(),l=this._state.getColumns();a?l=l.filter(t=>a.includes(t.data)):r||(l=l.filter(t=>!1!==t.visible)),i&&(n=n.filter(i));const h=[];if(o){const t=l.map(t=>this._escapeCSV(t.title||t.data,e));h.push(t.join(e))}n.forEach(t=>{if("data"!==t._type&&"infoRow"!==t._type)return;const s=l.map(s=>{let o=t[s.data];return s.exportFormat?o=s.exportFormat(o,t,s):s.format&&(o=s.format(o,t,s)),this._escapeCSV(o,e)});h.push(s.join(e))});const d=h.join("\n");return this._eventBus.emit(s.EXPORT_COMPLETE,{format:"csv",rowCount:h.length-(o?1:0)}),d}toExcel(t={}){const{sheetName:e="Sheet1",includeHeaders:o=!0,includeHidden:r=!1,columns:a=null,filter:i=null}=t;this._eventBus.emit(s.EXPORT_START,{format:"excel"});let n=this._state.getData(),l=this._state.getColumns();a?l=l.filter(t=>a.includes(t.data)):r||(l=l.filter(t=>!1!==t.visible)),i&&(n=n.filter(i));const h=[];o&&h.push(l.map(t=>t.title||t.data)),n.forEach(t=>{if("data"!==t._type&&"infoRow"!==t._type)return;const e=l.map(e=>{let s=t[e.data];return"number"===e.type&&"number"==typeof s||e.exportFormat&&(s=e.exportFormat(s,t,e)),s});h.push(e)});const d={sheets:[{name:e,data:h,columns:l.map(t=>({width:t.width||100,type:t.type||"string"}))}]};return this._eventBus.emit(s.EXPORT_COMPLETE,{format:"excel",rowCount:h.length-(o?1:0)}),d}download(t,e="table-export",s={}){"csv"===t?this._downloadCSV(e,s):"excel"===t&&this._downloadExcel(e,s)}_downloadCSV(t,e){const s=this.toCSV(e),o=new Blob([s],{type:"text/csv;charset=utf-8;"});this._downloadBlob(o,`${t}.csv`)}_downloadExcel(t,e){const s=this.toCSV({...e,delimiter:"\t"}),o=new Blob([s],{type:"application/vnd.ms-excel;charset=utf-8;"});this._downloadBlob(o,`${t}.xls`)}_downloadBlob(t,e){const s=document.createElement("a");if(void 0!==s.download){const o=URL.createObjectURL(t);s.setAttribute("href",o),s.setAttribute("download",e),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}}_escapeCSV(t,e=","){if(null==t)return"";const s=String(t);return s.includes(e)||s.includes('"')||s.includes("\n")||s.includes("\r")?`"${s.replace(/"/g,'""')}"`:s}preview(t=5,e="csv"){const s=this._state.getData().slice(0,t),o=this._state.getColumns().filter(t=>!1!==t.visible);if("csv"===e){return[o.map(t=>t.title||t.data).join(","),...s.map(t=>o.map(e=>this._escapeCSV(t[e.data])).join(","))].join("\n")}return{headers:o.map(t=>t.title||t.data),rows:s.map(t=>o.map(e=>t[e.data]))}}destroy(){}}class A{constructor(t,e={}){this._container=t,this._defaultTheme={rowEven:null,rowOdd:null,rowHover:null,rowSelected:null,borderLight:null,borderStrong:null,headerBackground:null,headerText:null,cellBackground:null,cellText:null,fixedBackground:null,fixedShadow:null,fixedBorderColor:null,fixedBorderWidth:null,primary:null,primaryHover:null,success:null,warning:null,error:null,rowTotalBackground:null,rowTotalBackgroundAlt:null,rowTotalText:null,rowTotalHeaderBackground:null,rowTotalBorderColor:null},this._theme={...this._defaultTheme,...e},this._applyTheme()}_applyTheme(){const t=this._container.style;this._theme.rowEven&&t.setProperty("--et-color-bg-alt",this._theme.rowEven),this._theme.rowOdd&&t.setProperty("--et-color-bg",this._theme.rowOdd),this._theme.rowHover&&t.setProperty("--et-color-bg-hover",this._theme.rowHover),this._theme.rowSelected&&t.setProperty("--et-color-bg-selected",this._theme.rowSelected),this._theme.borderLight&&t.setProperty("--et-color-border",this._theme.borderLight),this._theme.borderStrong&&t.setProperty("--et-color-border-strong",this._theme.borderStrong),this._theme.headerBackground&&t.setProperty("--et-color-header-bg",this._theme.headerBackground),this._theme.headerText&&t.setProperty("--et-color-header-text",this._theme.headerText),this._theme.cellBackground&&t.setProperty("--et-color-cell-bg",this._theme.cellBackground),this._theme.cellText&&t.setProperty("--et-color-text",this._theme.cellText),this._theme.fixedShadow&&t.setProperty("--et-shadow-fixed",this._theme.fixedShadow),this._theme.fixedBorderColor&&t.setProperty("--et-fixed-border-color",this._theme.fixedBorderColor),this._theme.fixedBorderWidth&&t.setProperty("--et-fixed-border-width",this._theme.fixedBorderWidth),this._theme.primary&&t.setProperty("--et-color-primary",this._theme.primary),this._theme.primaryHover&&t.setProperty("--et-color-primary-hover",this._theme.primaryHover),this._theme.success&&t.setProperty("--et-color-success",this._theme.success),this._theme.warning&&t.setProperty("--et-color-warning",this._theme.warning),this._theme.error&&t.setProperty("--et-color-error",this._theme.error),this._theme.rowTotalBackground&&t.setProperty("--et-row-total-bg",this._theme.rowTotalBackground),this._theme.rowTotalBackgroundAlt&&t.setProperty("--et-row-total-bg-alt",this._theme.rowTotalBackgroundAlt),this._theme.rowTotalText&&t.setProperty("--et-row-total-text",this._theme.rowTotalText),this._theme.rowTotalHeaderBackground&&t.setProperty("--et-row-total-header-bg",this._theme.rowTotalHeaderBackground),this._theme.rowTotalBorderColor&&t.setProperty("--et-row-total-border-color",this._theme.rowTotalBorderColor)}updateTheme(t){this._theme={...this._theme,...t},this._applyTheme()}resetTheme(){const t=this._container.style;Object.keys(this._theme).forEach(()=>{t.removeProperty("--et-color-bg-alt"),t.removeProperty("--et-color-bg"),t.removeProperty("--et-color-bg-hover"),t.removeProperty("--et-color-bg-selected"),t.removeProperty("--et-color-border"),t.removeProperty("--et-color-border-strong"),t.removeProperty("--et-color-header-bg"),t.removeProperty("--et-color-header-text"),t.removeProperty("--et-color-cell-bg"),t.removeProperty("--et-color-text"),t.removeProperty("--et-shadow-fixed"),t.removeProperty("--et-fixed-border-color"),t.removeProperty("--et-fixed-border-width"),t.removeProperty("--et-color-primary"),t.removeProperty("--et-color-primary-hover"),t.removeProperty("--et-color-success"),t.removeProperty("--et-color-warning"),t.removeProperty("--et-color-error"),t.removeProperty("--et-row-total-bg"),t.removeProperty("--et-row-total-bg-alt"),t.removeProperty("--et-row-total-text"),t.removeProperty("--et-row-total-header-bg"),t.removeProperty("--et-row-total-border-color")}),this._theme={...this._defaultTheme}}getTheme(){return{...this._theme}}}class D{constructor(t){if(this._validateConfig(t),this._config={fixedFirstColumn:!1,enableGrouping:!1,enableInfoRows:!1,enableRowTotals:!1,mode:"view",...t},this._container="string"==typeof t.container?document.querySelector(t.container):t.container,!this._container)throw new Error("Table: Container element not found");this._eventBus=new e,this._state=new u(this._eventBus,{data:t.data||[],columns:t.columns||[],config:{fixedFirstColumn:t.fixedFirstColumn,enableGrouping:t.enableGrouping,groupBy:t.groupBy,enableInfoRows:t.enableInfoRows,enableRowTotals:t.enableRowTotals,rowTotalsFormat:t.rowTotalsFormat}}),this._initModules(),this._state.setMode(t.mode||"view"),this._registerCallbacks(),this._render()}getData(){return this._state.getData()}setData(t){this._state.setData(t),this._render()}getRow(t){return this._state.getRow(t)}updateCell(t,e,s){this._state.updateCell(t,e,s)}batchUpdate(t){this._state.batchUpdate(t)}addRow(t,e={}){this._rowManager.addRow(t,e)}deleteRow(t){this._rowManager.deleteRow(t)}getDirtyRows(){return this._state.getDirtyRows()}clearDirty(){this._state.clearDirty()}revertChanges(){this._state.revertChanges(),this._render()}getColumns(){return this._state.getColumns()}setColumns(t){this._state.setColumns(t),this._render()}setColumnVisibility(t,e){const s=this._state.getColumns().map(s=>s._id===t||s.data===t?{...s,visible:e}:s);this._state.setColumns(s),this._render()}getMode(){return this._state.getMode()}setMode(t){this._state.setMode(t)}toggleMode(){const t=this._state.getMode();this._state.setMode("view"===t?"edit":"view")}toggleGroup(t){this._state.toggleGroup(t)}expandAllGroups(){this._state.expandAllGroups()}collapseAllGroups(){this._state.collapseAllGroups()}exportCSV(t={}){return this._exportManager.toCSV(t)}exportExcel(t={}){return this._exportManager.toExcel(t)}download(t,e){this._exportManager.download(t,e)}render(){this._render()}updateTheme(t){this._themeManager.updateTheme(t)}resetTheme(){this._themeManager.resetTheme()}getTheme(){return this._themeManager.getTheme()}on(t,e){return this._eventBus.on(t,e)}off(t,e){this._eventBus.off(t,e)}destroy(){this._eventBus.emit(s.DESTROY,{}),this._renderer.destroy(),this._themeManager.resetTheme(),this._rowManager.destroy(),this._groupManager.destroy(),this._editManager.destroy(),this._exportManager.destroy(),this._state.destroy(),this._eventBus.destroy(),this._container.innerHTML="",p(this._container,"et-container")}_validateConfig(t){if(!t)throw new Error("Table: Configuration object is required");if(!t.container)throw new Error("Table: Container element or selector is required");if(!t.columns||!Array.isArray(t.columns))throw new Error("Table: Columns array is required")}_initModules(){this._renderer=new g(this._container,this._state),this._themeManager=new A(this._container,this._config.theme),this._rowManager=new m(this._state,this._eventBus),this._groupManager=new x(this._state,this._eventBus),this._editManager=new B(this._state,this._eventBus,this._renderer),this._exportManager=new G(this._state,this._eventBus)}_registerCallbacks(){const{onRowClick:t,onRender:e,onChange:o,onRowChange:r}=this._config;t&&this._eventBus.on(s.ROW_CLICK,t),e&&this._eventBus.on(s.AFTER_RENDER,e),o&&this._eventBus.on(s.DATA_CHANGE,o),r&&this._eventBus.on(s.ROW_CHANGE,r)}_render(){this._eventBus.emit(s.BEFORE_RENDER,{}),this._renderer.render(),this._eventBus.emit(s.RENDER,{}),requestAnimationFrame(()=>{this._eventBus.emit(s.AFTER_RENDER,{rowCount:this._state.getData().length,columnCount:this._state.getColumns().length})})}}D.Events=s,t.EventBus=e,t.Table=D,t.TableState=u,t.default=D,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=datagrid.umd.min.js.map
