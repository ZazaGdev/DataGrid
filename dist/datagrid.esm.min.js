/*!
 * DataGrid v1.0.0
 * A modular, high-performance inline editing table library
 * (c) 2025
 * Released under the MIT License
 */
class t{constructor(){this._listeners=new Map,this._onceListeners=new Map,this._isBatching=!1,this._batchQueue=[]}on(t,e){return this._listeners.has(t)||this._listeners.set(t,new Set),this._listeners.get(t).add(e),()=>this.off(t,e)}once(t,e){const s=r=>{this.off(t,s),e(r)};this.on(t,s)}off(t,e){this._listeners.has(t)&&this._listeners.get(t).delete(e)}emit(t,e){this._isBatching?this._batchQueue.push({event:t,data:e}):this._listeners.has(t)&&this._listeners.get(t).forEach(s=>{try{s(e)}catch(e){console.error(`Error in event handler for "${t}":`,e)}})}startBatch(){this._isBatching=!0,this._batchQueue=[]}endBatch(){this._isBatching=!1;const t=new Map;this._batchQueue.forEach(({event:s,data:r})=>{let o=s;s===e.CELL_CHANGE&&r.rowId&&r.columnName?o=`${s}:${r.rowId}:${r.columnName}`:s===e.ROW_CHANGE&&r.rowId&&(o=`${s}:${r.rowId}`),t.set(o,{event:s,data:r})}),t.forEach(({event:t,data:e})=>{this.emit(t,e)}),this._batchQueue=[]}destroy(){this._listeners.clear(),this._batchQueue=[]}}const e={STATE_CHANGE:"state:change",DATA_CHANGE:"data:change",ROW_CLICK:"row:click",ROW_CHANGE:"row:change",ROW_ADD:"row:add",ROW_DELETE:"row:delete",CELL_CHANGE:"cell:change",CELL_FOCUS:"cell:focus",CELL_BLUR:"cell:blur",ROW_TOTAL_CHANGE:"rowTotal:change",GROUP_TOGGLE:"group:toggle",GROUP_EXPAND_ALL:"group:expandAll",GROUP_COLLAPSE_ALL:"group:collapseAll",MODE_CHANGE:"mode:change",BEFORE_RENDER:"lifecycle:beforeRender",RENDER:"lifecycle:render",AFTER_RENDER:"lifecycle:afterRender",DESTROY:"lifecycle:destroy",SCROLL:"scroll:update",EXPORT_START:"export:start",EXPORT_COMPLETE:"export:complete"};function s(){return`et_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}function r(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof Set)return new Set([...t].map(t=>r(t)));if(t instanceof Map)return new Map([...t].map(([t,e])=>[r(t),r(e)]));if(Array.isArray(t))return t.map(t=>r(t));const e={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=r(t[s]));return e}function o(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(typeof t!=typeof e)return!1;if("object"!=typeof t)return t===e;if(Array.isArray(t)!==Array.isArray(e))return!1;if(Array.isArray(t))return t.length===e.length&&t.every((t,s)=>o(t,e[s]));const s=Object.keys(t),r=Object.keys(e);return s.length===r.length&&s.every(s=>o(t[s],e[s]))}function a(t,e=0){if(null==t||""===t)return e;const s=parseFloat(t);return isNaN(s)?e:s}function i(t){return t.reduce((t,e)=>t+a(e),0)}function n(t){return 0===t.length?0:i(t)/t.length}function l(t){const e=t.filter(t=>!isNaN(a(t)));return e.length?Math.min(...e.map(a)):0}function d(t){const e=t.filter(t=>!isNaN(a(t)));return e.length?Math.max(...e.map(a)):0}class h{constructor(t,e={}){this._eventBus=t,this._state={data:[],originalData:[],columns:[],mode:"view",groups:{},groupedData:null,collapsedGroups:new Set,focusedCell:null,computedCache:new Map,dirtyRows:new Set,dirtyColumns:new Map,config:{fixedFirstColumn:!1,enableGrouping:!1,groupBy:null,enableInfoRows:!1,enableRowTotals:!1,...e.config}},e.data&&this.setData(e.data),e.columns&&this.setColumns(e.columns)}setData(t){this._state.originalData=r(t),this._state.data=this._normalizeData(t),this._state.dirtyRows.clear(),this._invalidateCache(),this._state.config.enableGrouping&&this._state.config.groupBy&&this._computeGroups(),this._eventBus.emit(e.DATA_CHANGE,{data:this._state.data,source:"setData"})}getData(){return r(this._state.data)}getRow(t){const e=this._state.data.find(e=>e._id===t);return e?r(e):null}updateCell(t,s,a,i={}){const n=this._state.data.findIndex(e=>e._id===t);if(-1===n)return;const l=this._state.data[n],d=l[s];o(d,a)||(l[s]=a,this._state.dirtyRows.add(t),this._state.dirtyColumns.has(t)||this._state.dirtyColumns.set(t,new Set),this._state.dirtyColumns.get(t).add(s),this._invalidateCacheForRow(t,s),this._eventBus.emit(e.CELL_CHANGE,{rowId:t,rowIndex:n,columnName:s,oldValue:d,newValue:a,row:r(l)}),this._eventBus.emit(e.ROW_CHANGE,{rowId:t,rowIndex:n,columnName:s,row:r(l),dirtyColumns:Array.from(this._state.dirtyColumns.get(t)||[])}),i.skipCascade||this._triggerCascadeUpdate(t,s,a))}batchUpdate(t){this._eventBus.startBatch(),t.forEach(({rowId:t,columnName:e,value:s})=>{this.updateCell(t,e,s,{skipCascade:!0})}),this._computeAllCascades(),this._eventBus.endBatch(),this._eventBus.emit(e.DATA_CHANGE,{data:this._state.data,source:"batchUpdate",updatedRows:t.map(t=>t.rowId)})}setColumns(t){this._state.columns=t.map((t,e)=>({...t,_index:e,_id:t.id||t.data||`col_${e}`})),this._eventBus.emit(e.STATE_CHANGE,{property:"columns",value:this._state.columns})}getColumns(){const t=[...this._state.columns];if(this._state.config.enableRowTotals){const e=t=>null!=t?`$${Number(t).toLocaleString()}`:"$0";t.push({data:"_rowTotal",title:"Total",type:"number",editable:!1,aggregate:"sum",_id:"_rowTotal",_index:t.length,_isRowTotal:!0,format:this._state.config.rowTotalsFormat||e})}return t}getColumn(t){if("_rowTotal"===t&&this._state.config.enableRowTotals){const t=t=>null!=t?`$${Number(t).toLocaleString()}`:"$0";return{data:"_rowTotal",title:"Total",type:"number",editable:!1,aggregate:"sum",_id:"_rowTotal",_isRowTotal:!0,format:this._state.config.rowTotalsFormat||t}}return this._state.columns.find(e=>e._id===t||e.data===t)}setMode(t){if("view"!==t&&"edit"!==t)return void console.warn(`Invalid mode: ${t}. Must be 'view' or 'edit'.`);const s=this._state.mode;this._state.mode=t,this._eventBus.emit(e.MODE_CHANGE,{oldMode:s,newMode:t})}getMode(){return this._state.mode}isEditMode(){return"edit"===this._state.mode}toggleGroup(t){this._state.collapsedGroups.has(t)?this._state.collapsedGroups.delete(t):this._state.collapsedGroups.add(t),this._eventBus.emit(e.GROUP_TOGGLE,{groupId:t,collapsed:this._state.collapsedGroups.has(t)})}isGroupCollapsed(t){return this._state.collapsedGroups.has(t)}getGroupedData(){return this._state.groupedData}getUngroupedRows(){return this._state.ungroupedRows||[]}getInfoRows(){return this._state.infoRows||[]}expandAllGroups(){this._state.collapsedGroups.clear(),this._eventBus.emit(e.GROUP_EXPAND_ALL,{})}collapseAllGroups(){this._state.groupedData&&Object.keys(this._state.groupedData).forEach(t=>{this._state.collapsedGroups.add(t)}),this._eventBus.emit(e.GROUP_COLLAPSE_ALL,{})}getDirtyRows(){return this._state.data.filter(t=>this._state.dirtyRows.has(t._id)).map(t=>r(t))}isRowDirty(t){return this._state.dirtyRows.has(t)}clearDirty(){this._state.dirtyRows.clear(),this._state.dirtyColumns.clear(),this._state.originalData=r(this._state.data)}revertChanges(){this.setData(this._state.originalData)}setConfig(t){this._state.config={...this._state.config,...t},void 0!==t.groupBy&&this._computeGroups(),this._eventBus.emit(e.STATE_CHANGE,{property:"config",value:this._state.config})}getConfig(){return{...this._state.config}}_normalizeData(t){return t.map((t,e)=>({...t,_id:t._id||t.id||s(),_index:e,_type:t._type||"data"}))}_computeGroups(){const{groupBy:t}=this._state.config;if(!t)return void(this._state.groupedData=null);const e={},s=[],r=[];this._state.data.forEach(o=>{if("infoRow"===o._type)return void r.push(o);if("data"!==o._type)return;const a="function"==typeof t?t(o):o[t];null!=a&&""!==a?(e[a]||(e[a]={id:a,label:a,rows:[],totals:{}}),e[a].rows.push(o)):s.push(o)}),this._state.groupedData=e,this._state.ungroupedRows=s,this._state.infoRows=r}_invalidateCache(){this._state.computedCache.clear()}_invalidateCacheForRow(t,e){this._state.computedCache.delete(`${t}:${e}`);const s=this.getColumn(e);s&&s.affectsColumns&&s.affectsColumns.forEach(t=>{this._state.computedCache.forEach((e,s)=>{s.includes(`:${t}`)&&this._state.computedCache.delete(s)})})}_triggerCascadeUpdate(t,e,s){const r=this.getColumn(e);r&&r.cascade&&r.cascade({rowId:t,columnName:e,value:s,state:this,updateCell:(t,e,s)=>{this.updateCell(t,e,s,{skipCascade:!0})}})}_computeAllCascades(){}destroy(){this._state.data=[],this._state.columns=[],this._state.computedCache.clear(),this._state.dirtyRows.clear(),this._state.dirtyColumns.clear(),this._state.collapsedGroups.clear()}}function u(t,e={}){const s=document.createElement(t);return function(t,e){Object.entries(e).forEach(([e,s])=>{"class"===e?t.className=s:"style"===e&&"object"==typeof s?Object.assign(t.style,s):e.startsWith("data-")?t.setAttribute(e,s):e in t?t[e]=s:t.setAttribute(e,s)})}(s,e),s}function c(t,...e){e.forEach(e=>{e&&t.classList.add(e)})}function _(t,...e){e.forEach(e=>{e&&t.classList.remove(e)})}class g{constructor(t,e){this._container=t,this._state=e,this._eventBus=e._eventBus,this._tableWrapper=null,this._table=null,this._thead=null,this._tbody=null,this._rowElements=new Map,this._cellElements=new Map,this._unsubscribers=[],this._setupEventListeners()}render(){const t=this._state.getConfig();this._tableWrapper||this._createStructure(),this._updateContainerClasses(t),this._renderHeader(),t.enableGrouping&&this._state.getGroupedData()?this._renderGroupedBody():this._renderBody()}updateCell(t,e,s){const r=`${t}:${e}`,o=this._cellElements.get(r);if(o){const r=this._state.getColumn(e);this._renderCellContent(o,s,r,this._state.getRow(t))}}updateRow(t){const e=this._rowElements.get(t),s=this._state.getRow(t);if(e&&s){this._state.getColumns().forEach(e=>{const r=`${t}:${e.data}`,o=this._cellElements.get(r);o&&this._renderCellContent(o,s[e.data],e,s)})}}getCellElement(t,e){return this._cellElements.get(`${t}:${e}`)||null}getRowElement(t){return this._rowElements.get(t)||null}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[],this._rowElements.clear(),this._cellElements.clear(),this._tableWrapper&&this._tableWrapper.remove()}_setupEventListeners(){this._unsubscribers.push(this._eventBus.on(e.CELL_CHANGE,({rowId:t,columnName:e,newValue:s})=>{this.updateCell(t,e,s)})),this._unsubscribers.push(this._eventBus.on(e.DATA_CHANGE,()=>{this.render()})),this._unsubscribers.push(this._eventBus.on(e.ROW_TOTAL_CHANGE,({rowId:t,newValue:e})=>{this.updateCell(t,"_rowTotal",e)})),this._unsubscribers.push(this._eventBus.on(e.STATE_CHANGE,({property:t,groupId:e})=>{"groupTotals"===t&&this._updateGroupHeaders(e)})),this._unsubscribers.push(this._eventBus.on(e.MODE_CHANGE,()=>{this.render()})),this._unsubscribers.push(this._eventBus.on(e.GROUP_TOGGLE,({groupId:t,collapsed:e})=>{this._toggleGroupVisibility(t,e)})),this._unsubscribers.push(this._eventBus.on(e.GROUP_EXPAND_ALL,()=>{this._setAllGroupsVisibility(!1)})),this._unsubscribers.push(this._eventBus.on(e.GROUP_COLLAPSE_ALL,()=>{this._setAllGroupsVisibility(!0)}))}_createStructure(){c(this._container,"dg-container"),this._tableWrapper=u("div",{class:"dg-table-wrapper"}),this._table=u("table",{class:"dg-table"}),this._thead=u("thead",{class:"dg-thead"}),this._tbody=u("tbody",{class:"dg-tbody"}),this._table.appendChild(this._thead),this._table.appendChild(this._tbody),this._tableWrapper.appendChild(this._table),this._container.appendChild(this._tableWrapper)}_updateContainerClasses(t){const e=this._state.getMode();_(this._container,"dg-mode-view","dg-mode-edit"),c(this._container,`dg-mode-${e}`),t.fixedFirstColumn?c(this._container,"dg-fixed-first-column"):_(this._container,"dg-fixed-first-column"),t.enableGrouping?c(this._container,"dg-grouped"):_(this._container,"dg-grouped")}_renderHeader(){const t=this._state.getColumns(),e=this._state.getConfig();this._thead.innerHTML="";const s=u("tr",{class:"dg-header-row"});let r=0;t.forEach(t=>{if(!1===t.visible)return;const o=u("th",{class:"dg-header-cell","data-column":t.data,"data-column-index":r});0===r&&e.fixedFirstColumn&&c(o,"dg-cell-fixed"),t._isRowTotal&&c(o,"dg-header-row-total");const a=u("div",{class:"dg-header-content"});a.textContent=t.title||t.data,o.appendChild(a),t.width&&(o.style.width="number"==typeof t.width?`${t.width}px`:t.width),s.appendChild(o),r++}),this._thead.appendChild(s)}_renderBody(){const t=this._state.getData(),e=this._state.getColumns();this._tbody.innerHTML="",this._rowElements.clear(),this._cellElements.clear(),t.forEach(t=>{const s=this._createRowElement(t,e);this._tbody.appendChild(s)})}_renderGroupedBody(){const t=this._state.getGroupedData(),e=this._state.getUngroupedRows(),s=this._state.getInfoRows(),r=this._state.getColumns();this._tbody.innerHTML="",this._rowElements.clear(),this._cellElements.clear(),s&&s.length>0&&s.forEach(t=>{const e=this._createRowElement(t,r,null);c(e,"dg-row-info"),this._tbody.appendChild(e)}),Object.entries(t).forEach(([t,e])=>{const s=this._createGroupHeaderRow(t,e,r);this._tbody.appendChild(s);const o=this._state.isGroupCollapsed(t);e.rows.forEach(e=>{const s=this._createRowElement(e,r,t);o&&c(s,"dg-row-hidden"),this._tbody.appendChild(s)})}),e.length>0&&e.forEach(t=>{const e=this._createRowElement(t,r,null);c(e,"dg-row-ungrouped"),this._tbody.appendChild(e)})}_createRowElement(t,s,r=null){const o=this._state.getConfig(),a=u("tr",{class:"dg-row "+("infoRow"===t._type?"dg-row-info-row":"dg-row-data"),"data-row-id":t._id,"data-row-index":t._index});r&&a.setAttribute("data-group",r),this._state.isRowDirty(t._id)&&c(a,"dg-row-dirty"),a.addEventListener("click",s=>{s.target.closest(".dg-cell-input")||this._eventBus.emit(e.ROW_CLICK,{rowId:t._id,rowIndex:t._index,row:this._state.getRow(t._id),event:s})});let i=0;return s.forEach(e=>{if(!1===e.visible)return;const s=this._createCellElement(t,e,i,o);a.appendChild(s),this._cellElements.set(`${t._id}:${e.data}`,s),i++}),this._rowElements.set(t._id,a),a}_createCellElement(t,e,s,r){const o=u("td",{class:"dg-cell","data-column":e.data});return 0===s&&r.fixedFirstColumn&&c(o,"dg-cell-fixed"),e._isRowTotal&&c(o,"dg-cell-row-total"),e.type&&c(o,`dg-cell-${e.type}`),e.align&&(o.style.textAlign=e.align),this._renderCellContent(o,t[e.data],e,t),o}_renderCellContent(t,e,s,r){const o=this._state.isEditMode(),a=!1!==s.editable&&"infoRow"!==r._type&&!1!==r._editable;if(t.innerHTML="",o&&a){const o=this._createInputElement(e,s,r);t.appendChild(o)}else{const o=this._formatDisplayValue(e,s,r);if(s.render){const o=s.render(e,r,s);"string"==typeof o?t.innerHTML=o:o instanceof HTMLElement&&t.appendChild(o)}else t.textContent=o}}_createInputElement(t,s,r){const o=s.inputType||s.type||"text";let a;return"select"===o&&s.options?(a=u("select",{class:"dg-cell-input dg-cell-select"}),s.options.forEach(e=>{const s=u("option",{value:e.value||e});s.textContent=e.label||e,(e.value||e)===t&&(s.selected=!0),a.appendChild(s)})):"textarea"===o?(a=u("textarea",{class:"dg-cell-input dg-cell-textarea",value:t||""}),a.textContent=t||""):(a=u("input",{class:"dg-cell-input",type:"number"===o?"number":"text",value:t??""}),"number"===o&&(void 0!==s.min&&(a.min=s.min),void 0!==s.max&&(a.max=s.max),void 0!==s.step&&(a.step=s.step))),a.addEventListener("focus",()=>{this._eventBus.emit(e.CELL_FOCUS,{rowId:r._id,columnName:s.data,value:t})}),a.addEventListener("blur",()=>{this._eventBus.emit(e.CELL_BLUR,{rowId:r._id,columnName:s.data,value:a.value})}),a.addEventListener("change",t=>{let e=t.target.value;"number"===o&&(e=""===e?null:parseFloat(e)),this._state.updateCell(r._id,s.data,e),s.onChange&&s.onChange({value:e,rowId:r._id,row:this._state.getRow(r._id),column:s})}),a}_formatDisplayValue(t,e,s){if(null==t)return e.defaultValue??"";if("infoRow"===s._type)return String(t);if(e.format)return e.format(t,s,e);if("number"===e.type&&"number"==typeof t)return void 0!==e.decimals?t.toFixed(e.decimals):t.toString();if("currency"===e.type){return new Intl.NumberFormat("en-US",{style:"currency",currency:e.currency||"USD"}).format(t)}if("date"===e.type&&t){return new Date(t).toLocaleDateString()}return String(t)}_createGroupHeaderRow(t,e,s){const r=this._state.getConfig(),o=this._state.isGroupCollapsed(t),a=s.filter(t=>!1!==t.visible),i=u("tr",{class:"dg-row dg-row-group-header","data-group":t}),n=e.totals||{};return a.forEach((s,a)=>{const l=u("td",{class:"dg-cell dg-cell-group-header","data-column":s.data});if(0===a&&r.fixedFirstColumn&&c(l,"dg-cell-fixed"),s._isRowTotal&&c(l,"dg-cell-row-total"),0===a){const s=u("div",{class:"dg-group-header-content"}),r=u("span",{class:"dg-group-toggle-icon "+(o?"dg-collapsed":"dg-expanded")});r.innerHTML=o?"▶":"▼";const a=u("span",{class:"dg-group-label"});a.textContent=e.label||t;const i=u("span",{class:"dg-group-count"});i.textContent=`(${e.rows.length})`,s.appendChild(r),s.appendChild(a),s.appendChild(i),l.appendChild(s)}else s.aggregate&&void 0!==n[s.data]&&(l.textContent=this._formatDisplayValue(n[s.data],s,{}),c(l,"dg-cell-aggregate"));s.align&&(l.style.textAlign=s.align),i.appendChild(l)}),i.addEventListener("click",()=>{this._state.toggleGroup(t)}),i}_createTotalsRow(t,e,s){const r=this._state.getConfig(),o=u("tr",{class:"dg-row dg-row-totals","data-group":s});return e.forEach((e,s)=>{if(!1===e.visible)return;const a=u("td",{class:"dg-cell dg-cell-total","data-column":e.data});0===s&&r.fixedFirstColumn&&c(a,"dg-cell-fixed"),void 0!==t[e.data]&&(a.textContent=this._formatDisplayValue(t[e.data],e,{})),o.appendChild(a)}),o}_toggleGroupVisibility(t,e){const s=this._tbody.querySelectorAll(`[data-group="${t}"]:not(.dg-row-group-header)`),r=this._tbody.querySelector(`.dg-row-group-header[data-group="${t}"]`);if(s.forEach(t=>{e?c(t,"dg-row-hidden"):_(t,"dg-row-hidden")}),r){const t=r.querySelector(".dg-group-toggle-icon");t&&(t.innerHTML=e?"▶":"▼",e?(_(t,"dg-expanded"),c(t,"dg-collapsed")):(_(t,"dg-collapsed"),c(t,"dg-expanded")))}}_setAllGroupsVisibility(t){const e=this._state.getGroupedData();e&&Object.keys(e).forEach(e=>{this._toggleGroupVisibility(e,t)})}_updateGroupHeaders(t=null){if(!this._tbody)return;const e=this._state.getGroupedData();if(!e)return;const s=this._state.getColumns();(t?[t]:Object.keys(e)).forEach(t=>{const r=e[t];if(!r)return;const o=this._tbody.querySelector(`.dg-row-group-header[data-group="${t}"]`);o&&s.forEach(t=>{if(t.aggregate&&void 0!==r.totals[t.data]){const e=o.querySelector(`[data-column="${t.data}"]`);e&&!e.querySelector(".dg-group-header-content")&&(e.textContent=this._formatDisplayValue(r.totals[t.data],t,{}))}})})}}class p{constructor(t,e){this._state=t,this._eventBus=e,this._unsubscribers=[],this._setupListeners()}addRow(t,r={}){const o=this._state.getData(),{index:a,groupId:i,afterRowId:n,type:l="data"}=r,d={...t,_id:t._id||s(),_type:l};let h=o.length;if(void 0!==a)h=Math.max(0,Math.min(a,o.length));else if(n){const t=o.findIndex(t=>t._id===n);-1!==t&&(h=t+1)}else if(i){const t=this._state.getConfig().groupBy;for(let e=o.length-1;e>=0;e--){if(("function"==typeof t?t(o[e]):o[e][t])===i){h=e+1;break}}"string"==typeof t&&(d[t]=i)}return o.splice(h,0,d),o.forEach((t,e)=>{t._index=e}),this._state.setData(o),this._eventBus.emit(e.ROW_ADD,{row:d,index:h}),d}addInfoRow(t,e){return this.addRow(e,{afterRowId:t,type:"infoRow"})}deleteRow(t){const s=this._state.getData(),r=s.findIndex(e=>e._id===t);if(-1===r)return!1;const o=s[r];return s.splice(r,1),s.forEach((t,e)=>{t._index=e}),this._state.setData(s),this._eventBus.emit(e.ROW_DELETE,{rowId:t,row:o,index:r}),!0}deleteRows(t){let e=0;const s=new Set(t),r=this._state.getData().filter(t=>!s.has(t._id)||(e++,!1));return e>0&&(r.forEach((t,e)=>{t._index=e}),this._state.setData(r)),e}duplicateRow(t){const e=this._state.getRow(t);if(!e)return null;const{_id:s,_index:r,...o}=e;return this.addRow(o,{afterRowId:t})}moveRow(t,e){const s=this._state.getData(),r=s.findIndex(e=>e._id===t);if(-1===r)return!1;const[o]=s.splice(r,1);return s.splice(e,0,o),s.forEach((t,e)=>{t._index=e}),this._state.setData(s),!0}getRowsByType(t){return this._state.getData().filter(e=>e._type===t)}getDataRows(){return this.getRowsByType("data")}getInfoRows(t){const e=this._state.getData(),s=e.findIndex(e=>e._id===t);if(-1===s)return[];const r=[];for(let t=s+1;t<e.length&&"infoRow"===e[t]._type;t++)r.push(e[t]);return r}_setupListeners(){}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[]}}const m="sum",f="average",w="min",y="max",C="count",b="first",v="last",E={[m]:t=>i(t),[f]:t=>n(t),[w]:t=>l(t),[y]:t=>d(t),[C]:t=>t.length,[b]:t=>t[0],[v]:t=>t[t.length-1]};function R(t,e){const s={};return e.forEach(e=>{if(e.aggregate){const o=t.filter(t=>"data"===t._type).map(t=>t[e.data]).filter(t=>null!=t),a="function"==typeof(r=e.aggregate)?r:E[r]||E[m];s[e.data]=a(o,t)}var r}),s}class T{constructor(t,e){this._state=t,this._eventBus=e,this._unsubscribers=[],this._setupListeners(),this._state.getConfig().enableGrouping&&this.recalculateTotals(),this._state.getConfig().enableRowTotals&&this.recalculateRowTotals()}calculateRowTotal(t){const e=this._state.getColumns();let s=0;return e.forEach(e=>{if(e.aggregate&&"_rowTotal"!==e.data){const r=t[e.data];null==r||isNaN(r)||(s+=Number(r))}}),s}recalculateRowTotals(){if(!this._state.getConfig().enableRowTotals)return;this._state._state.data.forEach(t=>{"data"===t._type&&(t._rowTotal=this.calculateRowTotal(t))})}updateRowTotal(t){if(!this._state.getConfig().enableRowTotals)return;const s=this._state._state.data.find(e=>e._id===t);if(s&&"data"===s._type){const r=s._rowTotal;s._rowTotal=this.calculateRowTotal(s),r!==s._rowTotal&&this._eventBus.emit(e.ROW_TOTAL_CHANGE,{rowId:t,oldValue:r,newValue:s._rowTotal})}}getGroup(t){const e=this._state.getGroupedData();return e?e[t]:null}getGroupIds(){const t=this._state.getGroupedData();return t?Object.keys(t):[]}getGroupRows(t){const e=this.getGroup(t);return e?e.rows:[]}getGroupTotals(t){const e=this.getGroup(t);return e?e.totals:{}}recalculateTotals(t=null){const s=this._state.getGroupedData(),r=this._state.getColumns(),o=this._state.getConfig();if(!s)return;(t?[t].filter(t=>s[t]):Object.keys(s)).forEach(t=>{const e=s[t],a={},i=e.rows.filter(t=>"data"===t._type);if(r.forEach(t=>{if(t.aggregate&&"_rowTotal"!==t.data){const e=i.map(e=>e[t.data]).filter(t=>null!=t&&!isNaN(t));a[t.data]=this._calculateAggregate(t.aggregate,e,i)}}),o.enableRowTotals){let t=0;r.forEach(e=>{e.aggregate&&"_rowTotal"!==e.data&&void 0!==a[e.data]&&(t+=a[e.data])}),a._rowTotal=t}e.totals=a}),this._eventBus.emit(e.STATE_CHANGE,{property:"groupTotals",groupId:t})}getGrandTotals(){return R(this._state.getData().filter(t=>"data"===t._type),this._state.getColumns())}toggle(t){return this._state.toggleGroup(t),this._state.isGroupCollapsed(t)}expand(t){this._state.isGroupCollapsed(t)&&this._state.toggleGroup(t)}collapse(t){this._state.isGroupCollapsed(t)||this._state.toggleGroup(t)}expandAll(){this._state.expandAllGroups()}collapseAll(){this._state.collapseAllGroups()}isCollapsed(t){return this._state.isGroupCollapsed(t)}getExpansionState(){const t=this.getGroupIds(),e={};return t.forEach(t=>{e[t]=!this._state.isGroupCollapsed(t)}),e}setExpansionState(t){Object.entries(t).forEach(([t,e])=>{e?this.expand(t):this.collapse(t)})}moveRowToGroup(t,e){const s=this._state.getConfig().groupBy;"string"==typeof s?(this._state.updateCell(t,s,e),this.recalculateTotals()):console.warn("Cannot move row when groupBy is a function")}getGroupStats(t){const e=this.getGroup(t);if(!e)return null;const s=this._state.getColumns(),r={rowCount:e.rows.length,columns:{}};return s.forEach(t=>{if("number"===t.type){const s=e.rows.map(e=>e[t.data]).filter(t=>null!=t&&!isNaN(t));r.columns[t.data]={sum:i(s),average:n(s),min:l(s),max:d(s),count:s.length}}}),r}_calculateAggregate(t,e,s){if("function"==typeof t)return t(e,s);switch(t){case"sum":default:return i(e);case"average":case"avg":return n(e);case"min":return l(e);case"max":return d(e);case"count":return e.length;case"first":return e[0];case"last":return e[e.length-1]}}_setupListeners(){this._unsubscribers.push(this._eventBus.on(e.CELL_CHANGE,({rowId:t,columnName:e})=>{const s=this._state.getColumn(e),r=this._state.getConfig();if(r.enableRowTotals&&s&&s.aggregate&&this.updateRowTotal(t),s&&s.aggregate&&r.enableGrouping){const e=this._state.getRow(t);if(e){const t=r.groupBy,s="function"==typeof t?t(e):e[t];this.recalculateTotals(s)}}})),this._unsubscribers.push(this._eventBus.on(e.DATA_CHANGE,()=>{const t=this._state.getConfig();t.enableRowTotals&&this.recalculateRowTotals(),t.enableGrouping&&this.recalculateTotals()}))}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[]}}class x{constructor(t,e,s){this._state=t,this._eventBus=e,this._renderer=s,this._focusedCell=null,this._isEditing=!1,this._unsubscribers=[],this._setupListeners()}enterEditMode(){this._state.setMode("edit")}enterViewMode(){this._state.setMode("view"),this._focusedCell=null}toggleMode(){const t="view"===this._state.getMode()?"edit":"view";return this._state.setMode(t),t}isEditMode(){return this._state.isEditMode()}focusCell(t,s){if(this._focusedCell={rowId:t,columnName:s},this._state.isEditMode()){const e=this._renderer.getCellElement(t,s);if(e){const t=e.querySelector(".dg-cell-input");t&&(t.focus(),t.select&&t.select())}}this._eventBus.emit(e.CELL_FOCUS,{rowId:t,columnName:s})}getFocusedCell(){return this._focusedCell}moveFocus(t){if(!this._focusedCell)return;const{rowId:e,columnName:s}=this._focusedCell,r=this._state.getData(),o=this._state.getColumns().filter(t=>!1!==t.visible),a=r.findIndex(t=>t._id===e),i=o.findIndex(t=>t.data===s);if(-1===a||-1===i)return;let n=a,l=i;switch(t){case"up":n=Math.max(0,a-1);break;case"down":n=Math.min(r.length-1,a+1);break;case"left":l=Math.max(0,i-1);break;case"right":l=Math.min(o.length-1,i+1)}if("up"===t||"down"===t){const e=r[n];if(e&&"data"!==e._type){const e="up"===t?-1:1;for(;n>=0&&n<r.length&&"data"!==r[n]._type;)n+=e;n=Math.max(0,Math.min(r.length-1,n))}}const d=r[n],h=o[l];d&&h&&this.focusCell(d._id,h.data)}startEditing(){if(!this._focusedCell||!this._state.isEditMode())return;this._isEditing=!0;const{rowId:t,columnName:e}=this._focusedCell,s=this._renderer.getCellElement(t,e);s&&c(s,"dg-cell-editing")}stopEditing(){if(!this._focusedCell)return;this._isEditing=!1;const{rowId:t,columnName:e}=this._focusedCell,s=this._renderer.getCellElement(t,e);s&&_(s,"dg-cell-editing")}isEditing(){return this._isEditing}cancelEdit(){if(!this._focusedCell||!this._isEditing)return;const{rowId:t,columnName:e}=this._focusedCell,s=this._state._state.originalData.find(e=>e._id===t);s&&this._state.updateCell(t,e,s[e]),this.stopEditing()}commitEdit(){if(!this._focusedCell||!this._isEditing)return;const{rowId:t,columnName:e}=this._focusedCell,s=this._renderer.getCellElement(t,e);if(s){const t=s.querySelector(".dg-cell-input");t&&t.dispatchEvent(new Event("change",{bubbles:!0}))}this.stopEditing()}_setupListeners(){document.addEventListener("keydown",t=>{if(this._state.isEditMode())switch(t.key){case"Tab":t.preventDefault(),this.moveFocus(t.shiftKey?"left":"right");break;case"Enter":this._isEditing&&(t.preventDefault(),this.commitEdit(),this.moveFocus("down"));break;case"Escape":this._isEditing&&(t.preventDefault(),this.cancelEdit());break;case"ArrowUp":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("up"));break;case"ArrowDown":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("down"));break;case"ArrowLeft":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("left"));break;case"ArrowRight":this._isEditing&&!t.ctrlKey||(t.preventDefault(),this.moveFocus("right"))}}),this._unsubscribers.push(this._eventBus.on(e.CELL_FOCUS,({rowId:t,columnName:e})=>{this._focusedCell={rowId:t,columnName:e}})),this._unsubscribers.push(this._eventBus.on(e.CELL_BLUR,()=>{this._isEditing=!1})),this._unsubscribers.push(this._eventBus.on(e.MODE_CHANGE,({newMode:t})=>{"view"===t&&(this._focusedCell=null,this._isEditing=!1)}))}destroy(){this._unsubscribers.forEach(t=>t()),this._unsubscribers=[],this._focusedCell=null,this._isEditing=!1}}class B{constructor(t,e){this._state=t,this._eventBus=e}toCSV(t={}){const{delimiter:s=",",includeHeaders:r=!0,includeHidden:o=!1,columns:a=null,filter:i=null}=t;this._eventBus.emit(e.EXPORT_START,{format:"csv"});let n=this._state.getData(),l=this._state.getColumns();a?l=l.filter(t=>a.includes(t.data)):o||(l=l.filter(t=>!1!==t.visible)),i&&(n=n.filter(i));const d=[];if(r){const t=l.map(t=>this._escapeCSV(t.title||t.data,s));d.push(t.join(s))}n.forEach(t=>{if("data"!==t._type&&"infoRow"!==t._type)return;const e=l.map(e=>{let r=t[e.data];return e.exportFormat?r=e.exportFormat(r,t,e):e.format&&(r=e.format(r,t,e)),this._escapeCSV(r,s)});d.push(e.join(s))});const h=d.join("\n");return this._eventBus.emit(e.EXPORT_COMPLETE,{format:"csv",rowCount:d.length-(r?1:0)}),h}toExcel(t={}){const{sheetName:s="Sheet1",includeHeaders:r=!0,includeHidden:o=!1,columns:a=null,filter:i=null}=t;this._eventBus.emit(e.EXPORT_START,{format:"excel"});let n=this._state.getData(),l=this._state.getColumns();a?l=l.filter(t=>a.includes(t.data)):o||(l=l.filter(t=>!1!==t.visible)),i&&(n=n.filter(i));const d=[];r&&d.push(l.map(t=>t.title||t.data)),n.forEach(t=>{if("data"!==t._type&&"infoRow"!==t._type)return;const e=l.map(e=>{let s=t[e.data];return"number"===e.type&&"number"==typeof s||e.exportFormat&&(s=e.exportFormat(s,t,e)),s});d.push(e)});const h={sheets:[{name:s,data:d,columns:l.map(t=>({width:t.width||100,type:t.type||"string"}))}]};return this._eventBus.emit(e.EXPORT_COMPLETE,{format:"excel",rowCount:d.length-(r?1:0)}),h}download(t,e="table-export",s={}){"csv"===t?this._downloadCSV(e,s):"excel"===t&&this._downloadExcel(e,s)}_downloadCSV(t,e){const s=this.toCSV(e),r=new Blob([s],{type:"text/csv;charset=utf-8;"});this._downloadBlob(r,`${t}.csv`)}_downloadExcel(t,e){const s=this.toCSV({...e,delimiter:"\t"}),r=new Blob([s],{type:"application/vnd.ms-excel;charset=utf-8;"});this._downloadBlob(r,`${t}.xls`)}_downloadBlob(t,e){const s=document.createElement("a");if(void 0!==s.download){const r=URL.createObjectURL(t);s.setAttribute("href",r),s.setAttribute("download",e),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}}_escapeCSV(t,e=","){if(null==t)return"";const s=String(t);return s.includes(e)||s.includes('"')||s.includes("\n")||s.includes("\r")?`"${s.replace(/"/g,'""')}"`:s}preview(t=5,e="csv"){const s=this._state.getData().slice(0,t),r=this._state.getColumns().filter(t=>!1!==t.visible);if("csv"===e){return[r.map(t=>t.title||t.data).join(","),...s.map(t=>r.map(e=>this._escapeCSV(t[e.data])).join(","))].join("\n")}return{headers:r.map(t=>t.title||t.data),rows:s.map(t=>r.map(e=>t[e.data]))}}destroy(){}}class G{constructor(t,e={}){this._container=t,this._defaultTheme={rowEven:null,rowOdd:null,rowHover:null,rowSelected:null,borderLight:null,borderStrong:null,headerBackground:null,headerText:null,cellBackground:null,cellText:null,fixedBackground:null,fixedShadow:null,fixedBorderColor:null,fixedBorderWidth:null,primary:null,primaryHover:null,success:null,warning:null,error:null,rowTotalBackground:null,rowTotalBackgroundAlt:null,rowTotalText:null,rowTotalHeaderBackground:null,rowTotalBorderColor:null,ungroupedRowBackground:null,ungroupedRowBackgroundAlt:null,ungroupedRowBackgroundHover:null,ungroupedRowText:null},this._theme={...this._defaultTheme,...e},this._applyTheme()}_resolveValue(t){return t&&"string"==typeof t&&t.startsWith("--")?`var(${t})`:t}_applyTheme(){const t=this._container.style;this._theme.rowEven&&t.setProperty("--dg-color-bg-alt",this._resolveValue(this._theme.rowEven)),this._theme.rowOdd&&t.setProperty("--dg-color-bg",this._resolveValue(this._theme.rowOdd)),this._theme.rowHover&&t.setProperty("--dg-color-bg-hover",this._resolveValue(this._theme.rowHover)),this._theme.rowSelected&&t.setProperty("--dg-color-bg-selected",this._resolveValue(this._theme.rowSelected)),this._theme.borderLight&&t.setProperty("--dg-color-border",this._resolveValue(this._theme.borderLight)),this._theme.borderStrong&&t.setProperty("--dg-color-border-strong",this._resolveValue(this._theme.borderStrong)),this._theme.headerBackground&&t.setProperty("--dg-color-header-bg",this._resolveValue(this._theme.headerBackground)),this._theme.headerText&&t.setProperty("--dg-color-header-text",this._resolveValue(this._theme.headerText)),this._theme.cellBackground&&t.setProperty("--dg-color-cell-bg",this._resolveValue(this._theme.cellBackground)),this._theme.cellText&&t.setProperty("--dg-color-text",this._resolveValue(this._theme.cellText)),this._theme.fixedShadow&&t.setProperty("--dg-shadow-fixed",this._resolveValue(this._theme.fixedShadow)),this._theme.fixedBorderColor&&t.setProperty("--dg-fixed-border-color",this._resolveValue(this._theme.fixedBorderColor)),this._theme.fixedBorderWidth&&t.setProperty("--dg-fixed-border-width",this._resolveValue(this._theme.fixedBorderWidth)),this._theme.primary&&t.setProperty("--dg-color-primary",this._resolveValue(this._theme.primary)),this._theme.primaryHover&&t.setProperty("--dg-color-primary-hover",this._resolveValue(this._theme.primaryHover)),this._theme.success&&t.setProperty("--dg-color-success",this._resolveValue(this._theme.success)),this._theme.warning&&t.setProperty("--dg-color-warning",this._resolveValue(this._theme.warning)),this._theme.error&&t.setProperty("--dg-color-error",this._resolveValue(this._theme.error)),this._theme.rowTotalBackground&&t.setProperty("--dg-row-total-bg",this._resolveValue(this._theme.rowTotalBackground)),this._theme.rowTotalBackgroundAlt&&t.setProperty("--dg-row-total-bg-alt",this._resolveValue(this._theme.rowTotalBackgroundAlt)),this._theme.rowTotalText&&t.setProperty("--dg-row-total-text",this._resolveValue(this._theme.rowTotalText)),this._theme.rowTotalHeaderBackground&&t.setProperty("--dg-row-total-header-bg",this._resolveValue(this._theme.rowTotalHeaderBackground)),this._theme.rowTotalBorderColor&&t.setProperty("--dg-row-total-border-color",this._resolveValue(this._theme.rowTotalBorderColor)),this._theme.ungroupedRowBackground&&t.setProperty("--dg-ungrouped-row-bg",this._resolveValue(this._theme.ungroupedRowBackground)),this._theme.ungroupedRowBackgroundAlt&&t.setProperty("--dg-ungrouped-row-bg-alt",this._resolveValue(this._theme.ungroupedRowBackgroundAlt)),this._theme.ungroupedRowBackgroundHover&&t.setProperty("--dg-ungrouped-row-bg-hover",this._resolveValue(this._theme.ungroupedRowBackgroundHover)),this._theme.ungroupedRowText&&t.setProperty("--dg-ungrouped-row-text",this._resolveValue(this._theme.ungroupedRowText))}updateTheme(t){this._theme={...this._theme,...t},this._applyTheme()}resetTheme(){const t=this._container.style;Object.keys(this._theme).forEach(()=>{t.removeProperty("--dg-color-bg-alt"),t.removeProperty("--dg-color-bg"),t.removeProperty("--dg-color-bg-hover"),t.removeProperty("--dg-color-bg-selected"),t.removeProperty("--dg-color-border"),t.removeProperty("--dg-color-border-strong"),t.removeProperty("--dg-color-header-bg"),t.removeProperty("--dg-color-header-text"),t.removeProperty("--dg-color-cell-bg"),t.removeProperty("--dg-color-text"),t.removeProperty("--dg-shadow-fixed"),t.removeProperty("--dg-fixed-border-color"),t.removeProperty("--dg-fixed-border-width"),t.removeProperty("--dg-color-primary"),t.removeProperty("--dg-color-primary-hover"),t.removeProperty("--dg-color-success"),t.removeProperty("--dg-color-warning"),t.removeProperty("--dg-color-error"),t.removeProperty("--dg-row-total-bg"),t.removeProperty("--dg-row-total-bg-alt"),t.removeProperty("--dg-row-total-text"),t.removeProperty("--dg-row-total-header-bg"),t.removeProperty("--dg-row-total-border-color"),t.removeProperty("--dg-ungrouped-row-bg"),t.removeProperty("--dg-ungrouped-row-bg-alt"),t.removeProperty("--dg-ungrouped-row-bg-hover"),t.removeProperty("--dg-ungrouped-row-text")}),this._theme={...this._defaultTheme}}getTheme(){return{...this._theme}}}class A{constructor(e){if(this._validateConfig(e),this._config={fixedFirstColumn:!1,enableGrouping:!1,enableInfoRows:!1,enableRowTotals:!1,mode:"view",...e},this._container="string"==typeof e.container?document.querySelector(e.container):e.container,!this._container)throw new Error("Table: Container element not found");this._eventBus=new t,this._state=new h(this._eventBus,{data:e.data||[],columns:e.columns||[],config:{fixedFirstColumn:e.fixedFirstColumn,enableGrouping:e.enableGrouping,groupBy:e.groupBy,enableInfoRows:e.enableInfoRows,enableRowTotals:e.enableRowTotals,rowTotalsFormat:e.rowTotalsFormat}}),this._initModules(),this._state.setMode(e.mode||"view"),this._registerCallbacks(),this._render()}getData(){return this._state.getData()}setData(t){this._state.setData(t),this._render()}getRow(t){return this._state.getRow(t)}updateCell(t,e,s){this._state.updateCell(t,e,s)}batchUpdate(t){this._state.batchUpdate(t)}addRow(t,e={}){this._rowManager.addRow(t,e)}deleteRow(t){this._rowManager.deleteRow(t)}getDirtyRows(){return this._state.getDirtyRows()}clearDirty(){this._state.clearDirty()}revertChanges(){this._state.revertChanges(),this._render()}getColumns(){return this._state.getColumns()}setColumns(t){this._state.setColumns(t),this._render()}setColumnVisibility(t,e){const s=this._state.getColumns().map(s=>s._id===t||s.data===t?{...s,visible:e}:s);this._state.setColumns(s),this._render()}getMode(){return this._state.getMode()}setMode(t){this._state.setMode(t)}toggleMode(){const t=this._state.getMode();this._state.setMode("view"===t?"edit":"view")}toggleGroup(t){this._state.toggleGroup(t)}expandAllGroups(){this._state.expandAllGroups()}collapseAllGroups(){this._state.collapseAllGroups()}exportCSV(t={}){return this._exportManager.toCSV(t)}exportExcel(t={}){return this._exportManager.toExcel(t)}download(t,e){this._exportManager.download(t,e)}render(){this._render()}updateTheme(t){this._themeManager.updateTheme(t)}resetTheme(){this._themeManager.resetTheme()}getTheme(){return this._themeManager.getTheme()}on(t,e){return this._eventBus.on(t,e)}off(t,e){this._eventBus.off(t,e)}destroy(){this._eventBus.emit(e.DESTROY,{}),this._renderer.destroy(),this._themeManager.resetTheme(),this._rowManager.destroy(),this._groupManager.destroy(),this._editManager.destroy(),this._exportManager.destroy(),this._state.destroy(),this._eventBus.destroy(),this._container.innerHTML="",_(this._container,"dg-container")}_validateConfig(t){if(!t)throw new Error("Table: Configuration object is required");if(!t.container)throw new Error("Table: Container element or selector is required");if(!t.columns||!Array.isArray(t.columns))throw new Error("Table: Columns array is required")}_initModules(){this._renderer=new g(this._container,this._state),this._themeManager=new G(this._container,this._config.theme),this._rowManager=new p(this._state,this._eventBus),this._groupManager=new T(this._state,this._eventBus),this._editManager=new x(this._state,this._eventBus,this._renderer),this._exportManager=new B(this._state,this._eventBus)}_registerCallbacks(){const{onRowClick:t,onRender:s,onChange:r,onRowChange:o}=this._config;t&&this._eventBus.on(e.ROW_CLICK,t),s&&this._eventBus.on(e.AFTER_RENDER,s),r&&this._eventBus.on(e.DATA_CHANGE,r),o&&this._eventBus.on(e.ROW_CHANGE,o)}_render(){this._eventBus.emit(e.BEFORE_RENDER,{}),this._renderer.render(),this._eventBus.emit(e.RENDER,{}),requestAnimationFrame(()=>{this._eventBus.emit(e.AFTER_RENDER,{rowCount:this._state.getData().length,columnCount:this._state.getColumns().length})})}}A.Events=e;export{t as EventBus,A as Table,h as TableState,A as default};
//# sourceMappingURL=datagrid.esm.min.js.map
